
R version 4.2.1 (2022-06-23) -- "Funny-Looking Kid"
Copyright (C) 2022 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> 
> ###########################################################################
> # Script downloading data from Weather Canada -----------------------------
> ###########################################################################
> 
> #### IMPORTANT NOTE ####
> # This script was run using weathercan package version 0.6.3
> # There seems to be a bug in newer version, or at least some incompatible with the following code.
> 
> 
> # packages ----------------------------------------------------------------
> 
> # install.packages("weathercan",  repos = c("https://ropensci.r-universe.dev", "https://cloud.r-project.org"))
> # install.packages(c('lutz', 'sf')) # dependencies
> library(dplyr)

Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

> library(weathercan)
weathercan v0.6.3
The internal `stations` data has been deprecated in favour of the function `stations()`.
See ?stations for more details.
> 
> 
> 
> # select stations ---------------------------------------------------------
> 
> ?stations
stations              package:weathercan               R Documentation

_A_c_c_e_s_s _S_t_a_t_i_o_n _d_a_t_a _d_o_w_n_l_o_a_d_e_d _f_r_o_m _E_n_v_i_r_o_n_m_e_n_t _a_n_d _C_l_i_m_a_t_e _C_h_a_n_g_e
_C_a_n_a_d_a

_D_e_s_c_r_i_p_t_i_o_n:

     This function access the built-in stations data frame. You can
     update this data frame with ‘stations_dl()’ which will update the
     locally stored data.

_U_s_a_g_e:

     stations()
     
_F_o_r_m_a_t:

     A data frame:

     prov Province

     station_name Station name

     station_id Environment Canada's station ID number. Required for
          downloading station data.

     climate_id Climate ID number

     WMO_id Climate ID number

     TC_id Climate ID number

     lat Latitude of station location in degree decimal format

     lon Longitude of station location in degree decimal format

     elev Elevation of station location in metres

     tz Local timezone excluding any Daylight Savings

     interval Interval of the data measurements ('hour', 'day',
          'month')

     start Starting year of data record

     end Ending year of data record

     normals Whether current climate normals are available for that
          station

     normals_1981_2010 Whether 1981-2010 climate normals are available
          for that station

     normals_1971_2000 Whether 1981-2010 climate normals are available
          for that station

_D_e_t_a_i_l_s:

     You can check when this was last updated with ‘stations_meta()’.

     A dataset containing station information downloaded from
     Environment and Climate Change Canada. Note that a station may
     have several station IDs, depending on how the data collection has
     changed over the years. Station information can be updated by
     running ‘stations_dl()’.

_S_o_u_r_c_e:

     <https://climate.weather.gc.ca/index_e.html>

_E_x_a_m_p_l_e_s:

     stations()
     stations_meta()
     
     library(dplyr)
     filter(stations(), interval == "hour", normals == TRUE, prov == "MB")
     

> names(stations())
 [1] "prov"              "station_name"      "station_id"       
 [4] "climate_id"        "WMO_id"            "TC_id"            
 [7] "lat"               "lon"               "elev"             
[10] "tz"                "interval"          "start"            
[13] "end"               "normals"           "normals_1981_2010"
[16] "normals_1971_2000"
> stations() %>%
+   filter(start <= 1900, end >= 2000, interval == "day") %>%
+   print(n=nrow(.))
# A tibble: 51 × 16
   prov  stati…¹ stati…² clima…³ WMO_id TC_id   lat    lon    elev tz    inter…⁴
   <chr> <chr>     <dbl> <chr>    <dbl> <chr> <dbl>  <dbl>   <dbl> <chr> <chr>  
 1 AB    CALGAR…    2205 3031093  71877 YYC    51.1 -114.  1084.   Etc/… day    
 2 AB    MEDICI…    2273 3034480     NA YXH    50.0 -111.   717.   Etc/… day    
 3 BC    VICTOR…     113 1018610     NA WLM    48.4 -123.    69.5  Etc/… day    
 4 BC    QUATSI…     271 1036570     NA <NA>   50.5 -128.     3.42 Etc/… day    
 5 BC    MASSET…     360 1054920     NA ZMT    54.0 -132.     5.8  Etc/… day    
 6 BC    BELLA …     380 1060840     NA <NA>   52.4 -127.    18.3  Etc/… day    
 7 BC    BARKER…     568 1090660     NA <NA>   53.1 -122.  1283    Etc/… day    
 8 BC    FORT S…     588 1092970     NA <NA>   54.5 -124.   691    Etc/… day    
 9 BC    AGASSI…     707 1100120     NA <NA>   49.2 -122.    15    Etc/… day    
10 BC    CHILLI…     735 1101530     NA <NA>   49.2 -122.    11    Etc/… day    
11 BC    STEVES…     869 1107710     NA <NA>   49.1 -123.    NA    Etc/… day    
12 BC    KASLO      1124 1143900     NA <NA>   49.9 -117.   600    Etc/… day    
13 BC    ROSSLA…    1147 1146870     NA <NA>   49.1 -118.  1039    Etc/… day    
14 BC    ATLIN      1485 1200560     NA <NA>   59.6 -134.   674.   Etc/… day    
15 MB    BIRTLE     3469 5010240     NA <NA>   50.4 -101.   522    Etc/… day    
16 MB    BRANDO…    3472 5010485     NA <NA>   49.9 -100.   363.   Etc/… day    
17 MB    VIRDEN     3560 5012960     NA <NA>   49.8 -101.   445.   Etc/… day    
18 MB    GRETNA…    3605 5021220  71441 WGN    49.0  -97.6  253.   Etc/… day    
19 MB    OAKBANK    3641 5022051     NA <NA>   49.9  -96.8  246.   Etc/… day    
20 MB    YORK F…    3912 5063350     NA <NA>   57    -92.3    6    Etc/… day    
21 NB    GAGETO…    6160 8101800     NA <NA>   45.8  -66.2   33.5  Etc/… day    
22 NB    MONCTON    6206 8103100     NA <NA>   46.1  -64.8   12.2  Etc/… day    
23 NB    SUSSEX     6268 8105200     NA <NA>   45.7  -65.5   21.3  Etc/… day    
24 NB    WOODST…    6286 8105600     NA <NA>   46.2  -67.6  153    Etc/… day    
25 NS    BADDECK    6297 8200300     NA <NA>   46.1  -60.8    7.6  Etc/… day    
26 NS    NAPPAN…    6414 8203700     NA <NA>   45.8  -64.2   19.8  Etc/… day    
27 NS    PARRSB…    6428 8204400     NA <NA>   45.4  -64.3   24.3  Etc/… day    
28 NS    SABLE …    6454 8204700  71600 ESA    43.9  -60.0    5    Etc/… day    
29 ON    STURGE…    4205 6088144     NA <NA>   46.4  -79.9  201    Etc/… day    
30 ON    OTTAWA…    4333 6105976     NA WCG    45.4  -75.7   79.2  Etc/… day    
31 ON    DURHAM     4442 6112171     NA <NA>   44.2  -80.8  384    Etc/… day    
32 ON    MIDLAN…    4474 6115127     NA <NA>   44.8  -79.9  180    Etc/… day    
33 ON    KINCAR…    4575 6124127     NA <NA>   44.2  -81.6  200    Etc/… day    
34 ON    WELLAND    4712 6139445     NA <NA>   43.0  -79.3  175.   Etc/… day    
35 ON    WINDSO…    4715 6139520     NA <NA>   42.3  -82.9  188.   Etc/… day    
36 ON    WOODST…    4835 6149625     NA <NA>   43.1  -80.8  282.   Etc/… day    
37 ON    BELLEV…    4859 6150689     NA <NA>   44.2  -77.4   76.2  Etc/… day    
38 ON    BLOOMF…    4862 6150815     NA <NA>   44.0  -77.2   91.4  Etc/… day    
39 ON    TORONTO    5051 6158350  71266 <NA>   43.7  -79.4  112.   Etc/… day    
40 ON    MINDEN     5181 6165195     NA <NA>   44.9  -78.7  274.   Etc/… day    
41 QC    BROME      5325 7020840     NA <NA>   45.2  -72.6  206.   Etc/… day    
42 QC    DANVIL…    5345 7021954     NA <NA>   45.8  -72.0  190    Etc/… day    
43 QC    HUNTIN…    5374 7023240     NA <NA>   45.0  -74.2   49.1  Etc/… day    
44 QC    LENNOX…    5397 7024280  71611 WQH    45.4  -71.8  181    Etc/… day    
45 QC    RICHMO…    5440 7026465     NA <NA>   45.6  -72.1  123.   Etc/… day    
46 SK    INDIAN…    2925 4013480  71515 WBD    50.6 -104.   579.   Etc/… day    
47 SK    MOOSOM…    2971 4015360     NA <NA>   50.1 -102.   576.   Etc/… day    
48 SK    REGINA…    3002 4016560  71863 YQR    50.4 -105.   578.   Etc/… day    
49 SK    WEYBURN    3050 4018760     NA <NA>   49.6 -104.   570.   Etc/… day    
50 SK    SASKAT…    3328 4057120  71866 YXE    52.2 -107.   504.   Etc/… day    
51 YT    PELLY …    1586 2100880     NA <NA>   62.8 -137.   445    Etc/… day    
# … with 5 more variables: start <dbl>, end <dbl>, normals <lgl>,
#   normals_1981_2010 <lgl>, normals_1971_2000 <lgl>, and abbreviated variable
#   names ¹​station_name, ²​station_id, ³​climate_id, ⁴​interval
> 
> stations() %>%
+   filter(start <= 1900, end >= 2000, interval == "day") %>%
+   select(station_name) %>%
+   print(n=nrow(.))
# A tibble: 51 × 1
   station_name                         
   <chr>                                
 1 CALGARY INT'L A                      
 2 MEDICINE HAT A                       
 3 VICTORIA GONZALES HTS                
 4 QUATSINO                             
 5 MASSET AIRPORT                       
 6 BELLA COOLA                          
 7 BARKERVILLE                          
 8 FORT ST JAMES                        
 9 AGASSIZ CDA                          
10 CHILLIWACK                           
11 STEVESTON                            
12 KASLO                                
13 ROSSLAND CITY YARD                   
14 ATLIN                                
15 BIRTLE                               
16 BRANDON CDA                          
17 VIRDEN                               
18 GRETNA (AUT)                         
19 OAKBANK                              
20 YORK FACTORY                         
21 GAGETOWN 2                           
22 MONCTON                              
23 SUSSEX                               
24 WOODSTOCK                            
25 BADDECK                              
26 NAPPAN CDA                           
27 PARRSBORO                            
28 SABLE ISLAND                         
29 STURGEON FALLS                       
30 OTTAWA CDA                           
31 DURHAM                               
32 MIDLAND WATER POLLUTION CONTROL PLANT
33 KINCARDINE                           
34 WELLAND                              
35 WINDSOR RIVERSIDE                    
36 WOODSTOCK                            
37 BELLEVILLE                           
38 BLOOMFIELD                           
39 TORONTO                              
40 MINDEN                               
41 BROME                                
42 DANVILLE                             
43 HUNTINGDON                           
44 LENNOXVILLE                          
45 RICHMOND                             
46 INDIAN HEAD CDA                      
47 MOOSOMIN                             
48 REGINA INT'L A                       
49 WEYBURN                              
50 SASKATOON DIEFENBAKER INT'L A        
51 PELLY RANCH                          
> 
> # Interesting selections:
> 
> # airports: !is.na(TC_id)
> # stns <- stations() %>%
> #   filter(start <= 1900, end >= 2000, interval == "day", !is.na(TC_id))
> # stns_id <- stns %>%
> #   dplyr::select(station_id) %>%
> #   unlist(use.names = F)
> 
> # stns_id <- c(271, 568, 707, 4333, 4712, 4859, 4862, 5051)
> stns_id <- c(4712, 5051, 4333)
> stns <- stations() %>%
+   filter(station_id %in% stns_id, interval == "day")
> stns
# A tibble: 3 × 16
  prov  station_n…¹ stati…² clima…³ WMO_id TC_id   lat   lon  elev tz    inter…⁴
  <chr> <chr>         <dbl> <chr>    <dbl> <chr> <dbl> <dbl> <dbl> <chr> <chr>  
1 ON    OTTAWA CDA     4333 6105976     NA WCG    45.4 -75.7  79.2 Etc/… day    
2 ON    WELLAND        4712 6139445     NA <NA>   43.0 -79.3 175.  Etc/… day    
3 ON    TORONTO        5051 6158350  71266 <NA>   43.7 -79.4 112.  Etc/… day    
# … with 5 more variables: start <dbl>, end <dbl>, normals <lgl>,
#   normals_1981_2010 <lgl>, normals_1971_2000 <lgl>, and abbreviated variable
#   names ¹​station_name, ²​station_id, ³​climate_id, ⁴​interval
> 
> 
> 
> # download raw data -------------------------------------------------------
> 
> # from terminal (see note at beginning of script):
> # R CMD BATCH --vanilla --no-restore app/0-download-data.R app/log_dd.txt
> 
> for(stn in stns_id){
+   data <- weather_dl(stn, interval = "day", trim = F, verbose = T)
+   saveRDS(data, paste0("app/data/daily_data_", stn, ".rds"))
+ }
Getting station: 4712
Formatting station data: 4712
Adding header data: 4712
Getting station: 5051
Formatting station data: 5051
Adding header data: 5051
Some variables have non-numeric values (spd_max_gust), for stations: 5051
  Replaced all non-numeric entries with NA. Use 'string_as = NULL' to keep as characters (see ?weather_dl).
  Examples:  
  # A tibble: 20 × 6
     station_id date       year  month day   spd_max_gust
          <dbl> <date>     <chr> <chr> <chr> <chr>       
   1       5051 1955-03-04 1955  03    04    <31         
   2       5051 1955-03-05 1955  03    05    <31         
   3       5051 1955-03-09 1955  03    09    <31         
   4       5051 1955-03-10 1955  03    10    <31         
   5       5051 1955-03-15 1955  03    15    <31         
   6       5051 1955-03-19 1955  03    19    <31         
   7       5051 1955-03-25 1955  03    25    <31         
   8       5051 1955-03-29 1955  03    29    <31         
   9       5051 1955-03-30 1955  03    30    <31         
  10       5051 1955-03-31 1955  03    31    <31         
  11       5051 1955-04-02 1955  04    02    <31         
  12       5051 1955-04-03 1955  04    03    <31         
  13       5051 1955-04-04 1955  04    04    <31         
  14       5051 1955-04-08 1955  04    08    <31         
  15       5051 1955-04-14 1955  04    14    <31         
  16       5051 1955-04-16 1955  04    16    <31         
  17       5051 1955-04-17 1955  04    17    <31         
  18       5051 1955-04-18 1955  04    18    <31         
  19       5051 1955-04-19 1955  04    19    <31         
  20       5051 1955-04-22 1955  04    22    <31         
Getting station: 4333
Formatting station data: 4333
Adding header data: 4333
> 
> # record successful downloads
> stns_id <- sapply(strsplit(list.files("app/data/", "daily_data"), "_"), \(x) x[3])
> stns_id <- as.numeric(sapply(strsplit(stns_id, "\\."), \(x) x[1]))
> saveRDS(stns_id, "app/data/stns_id.rds")
> 
> proc.time()
    user   system  elapsed 
 162.851    1.407 1061.524 
