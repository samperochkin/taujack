
R version 4.2.1 (2022-06-23) -- "Funny-Looking Kid"
Copyright (C) 2022 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # Preprocessing of the raw data
> # launched with 
> # R CMD BATCH --vanilla --no-restore app/preprocessing.R app/log_pp.txt
> 
> # packages ----------------------------------------------------------------
> library(tidyverse)
── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
✔ ggplot2 3.3.6     ✔ purrr   0.3.4
✔ tibble  3.1.8     ✔ dplyr   1.1.0
✔ tidyr   1.2.1     ✔ stringr 1.4.1
✔ readr   2.1.2     ✔ forcats 0.5.2
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
> library(lubridate)

Attaching package: ‘lubridate’

The following objects are masked from ‘package:base’:

    date, intersect, setdiff, union

> library(lunar)
> library(ggplot2)
> library(spatstat.geom) # weighted ecdf
Loading required package: spatstat.data
spatstat.geom 3.2-4
> 
> 
> 
> # load and preprocess data ------------------------------------------------
> stns_id <- readRDS("app/data/stns_id.rds")
> weathercan::stations() %>% filter(station_id %in% stns_id, interval == "day") %>%
+   print(nrow = nrow(.))
The stations data frame hasn't been updated in over 4 weeks. Consider running `stations_dl()` to check for updates and make sure you have the most recent stations list available
# A tibble: 8 × 16
  prov  station…¹ stati…² clima…³ WMO_id TC_id   lat    lon   elev tz    inter…⁴
  <chr> <chr>       <dbl> <chr>    <dbl> <chr> <dbl>  <dbl>  <dbl> <chr> <chr>  
1 BC    QUATSINO      271 1036570     NA <NA>   50.5 -128.  3.42e0 Etc/… day    
2 BC    BARKERVI…     568 1090660     NA <NA>   53.1 -122.  1.28e3 Etc/… day    
3 BC    AGASSIZ …     707 1100120     NA <NA>   49.2 -122.  1.5 e1 Etc/… day    
4 ON    OTTAWA C…    4333 6105976     NA WCG    45.4  -75.7 7.92e1 Etc/… day    
5 ON    WELLAND      4712 6139445     NA <NA>   43.0  -79.3 1.75e2 Etc/… day    
6 ON    BELLEVIL…    4859 6150689     NA <NA>   44.2  -77.4 7.62e1 Etc/… day    
7 ON    BLOOMFIE…    4862 6150815     NA <NA>   44.0  -77.2 9.14e1 Etc/… day    
8 ON    TORONTO      5051 6158350  71266 <NA>   43.7  -79.4 1.12e2 Etc/… day    
# … with 5 more variables: start <dbl>, end <dbl>, normals <lgl>,
#   normals_1981_2010 <lgl>, normals_1971_2000 <lgl>, and abbreviated variable
#   names ¹​station_name, ²​station_id, ³​climate_id, ⁴​interval
> 
> filepaths <- paste0("app/data/daily_data_", stns_id, ".rds")
> data <- lapply(filepaths, readRDS) |> dplyr::bind_rows()
> str(data)
tibble [421,408 × 37] (S3: tbl_df/tbl/data.frame)
 $ station_name      : chr [1:421408] "QUATSINO" "QUATSINO" "QUATSINO" "QUATSINO" ...
 $ station_id        : num [1:421408] 271 271 271 271 271 271 271 271 271 271 ...
 $ station_operator  : logi [1:421408] NA NA NA NA NA NA ...
 $ prov              : chr [1:421408] "BC" "BC" "BC" "BC" ...
 $ lat               : num [1:421408] 50.5 50.5 50.5 50.5 50.5 ...
 $ lon               : num [1:421408] -128 -128 -128 -128 -128 ...
 $ elev              : num [1:421408] 3.4 3.4 3.4 3.4 3.4 3.4 3.4 3.4 3.4 3.4 ...
 $ climate_id        : chr [1:421408] "1036570" "1036570" "1036570" "1036570" ...
 $ WMO_id            : chr [1:421408] NA NA NA NA ...
 $ TC_id             : chr [1:421408] NA NA NA NA ...
 $ date              : Date[1:421408], format: "1895-01-01" "1895-01-02" ...
 $ year              : chr [1:421408] "1895" "1895" "1895" "1895" ...
 $ month             : chr [1:421408] "01" "01" "01" "01" ...
 $ day               : chr [1:421408] "01" "02" "03" "04" ...
 $ qual              : chr [1:421408] NA NA NA NA ...
 $ cool_deg_days     : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ cool_deg_days_flag: chr [1:421408] NA NA NA NA ...
 $ dir_max_gust      : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ dir_max_gust_flag : chr [1:421408] NA NA NA NA ...
 $ heat_deg_days     : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ heat_deg_days_flag: chr [1:421408] NA NA NA NA ...
 $ max_temp          : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ max_temp_flag     : chr [1:421408] NA NA NA NA ...
 $ mean_temp         : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ mean_temp_flag    : chr [1:421408] NA NA NA NA ...
 $ min_temp          : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ min_temp_flag     : chr [1:421408] NA NA NA NA ...
 $ snow_grnd         : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ snow_grnd_flag    : chr [1:421408] NA NA NA NA ...
 $ spd_max_gust      : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ spd_max_gust_flag : chr [1:421408] NA NA NA NA ...
 $ total_precip      : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ total_precip_flag : chr [1:421408] NA NA NA NA ...
 $ total_rain        : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ total_rain_flag   : chr [1:421408] NA NA NA NA ...
 $ total_snow        : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ total_snow_flag   : chr [1:421408] NA NA NA NA ...
> 
> # time variables setup
> data <- data %>% mutate(date = as.Date(date),
+                         year = as.integer(year),
+                         month = as.integer(month),
+                         day = as.integer(day))
> 
> data <- data %>% mutate(time = as.integer(date),
+                         yday = lubridate::yday(date),
+                         week = lubridate::week(date))
> 
> # stations we look at
> stns_id <- c(568, 4333, 5051)
> p <- 3
> data <- data %>%
+   filter(station_id %in% stns_id) %>%
+   arrange(station_id, date)
> 
> # quick look at summary of the data (clearly shows time trends)
> data0 <- data %>% group_by(station_name, year) %>%
+   summarise(mm_temp = mean(mean_temp, na.rm=T))
`summarise()` has grouped output by 'station_name'. You can override using the
`.groups` argument.
> ggplot(data0, aes(x=year, y=mm_temp)) +
+   geom_line() +
+   geom_point() +
+   facet_wrap(~station_name)
Warning messages:
1: Removed 20 row(s) containing missing values (geom_path). 
2: Removed 25 rows containing missing values (geom_point). 
> 
> 
> # Estimate mean conditional on time of year -------------------------------
> year_len <- 365 + 6/24 + 9/60/24 + 9/60^2/24
> 
> # create sines-cosines basis (for seasonal trend)
> nSC <- 6
> s_cols <- paste0("s", 1:nSC)
> c_cols <- paste0("c", 1:nSC)
> for (i in 1:nSC) data <- data %>%
+   mutate(!!s_cols[i] := sin(i*2*pi*time/year_len),
+          !!c_cols[i] := cos(i*2*pi*time/year_len))
> 
> 
> # create natural spline basis (for long term time trend)
> # for this check range for each station
> row_ids <- sapply(stns_id, \(id) data$station_id == id)
> bss <- lapply(1:p, \(k){
+   data[row_ids[,k],] %>% filter(day == 21, month %in% c(6,12)) %>% select(time) %>% unlist
+ })
> 
> for(b in paste("b", 1:max(sapply(bss, length)))) data <- data %>% mutate(!!b := NA)
> nB <- rep(0, p); b_cols <- list()
> for(k in 1:p){
+   B <- splines::bs(data[row_ids[,k],]$time, knots = c(bss[[k]]), degree = 2)
+   B <- B[,colSums(abs(B[!is.na(data[row_ids[,k],]$mean_temp),])) > 1e-5]
+   nB[k] <- ncol(B)
+   b_cols[[length(b_cols)+1]] <- paste0("b", 1:nB[k])
+   data[row_ids[,k],b_cols[[k]]] <- B
+   rm(B)
+ }
> 
> 
> # fit least-squares
> non_na <- !is.na(data$mean_temp) # for later
> lms <- lapply(1:p, \(k){
+   x_cols <- c("mean_temp", s_cols, c_cols, b_cols[[k]])
+   lm(formula = "mean_temp~.", data = data[row_ids[,k],x_cols])
+ })
> 
> # Bakerville
> summary(lms[[1]])

Call:
lm(formula = "mean_temp~.", data = data[row_ids[, k], x_cols])

Residuals:
     Min       1Q   Median       3Q      Max 
-31.6225  -2.4347   0.2505   2.9929  18.7826 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept)   7.95843    2.07920   3.828 0.000130 ***
s1           -4.74834    3.52201  -1.348 0.177605    
s2            0.57348    0.03170  18.089  < 2e-16 ***
s3            0.01546    0.11598   0.133 0.893936    
s4            0.23325    0.03148   7.408 1.30e-13 ***
s5           -0.19063    0.03557  -5.359 8.42e-08 ***
s6           -0.09513    0.03147  -3.023 0.002505 ** 
c1          -10.53323    0.68133 -15.460  < 2e-16 ***
c2           -0.32021    0.03167 -10.110  < 2e-16 ***
c3           -0.05983    0.07867  -0.761 0.446940    
c4           -0.11826    0.03151  -3.753 0.000175 ***
c5            0.14105    0.03921   3.597 0.000322 ***
c6           -0.12758    0.03145  -4.056 5.00e-05 ***
b1           -3.58156    5.83755  -0.614 0.539524    
b2           -6.65893    8.10033  -0.822 0.411049    
b3           -1.75921    6.18465  -0.284 0.776069    
b4           -7.65652    8.21565  -0.932 0.351371    
b5           -4.62014    6.17987  -0.748 0.454699    
b6           -6.84254    8.22527  -0.832 0.405474    
b7           -4.47635    6.18750  -0.723 0.469407    
b8           -7.00580    8.22135  -0.852 0.394136    
b9           -4.20287    6.19319  -0.679 0.497377    
b10          -7.49660    8.21440  -0.913 0.361448    
b11          -4.42717    6.19332  -0.715 0.474718    
b12          -8.81569    8.25227  -1.068 0.285402    
b13          -3.38876    6.18461  -0.548 0.583739    
b14          -7.92211    8.23122  -0.962 0.335830    
b15          -2.69900    6.18636  -0.436 0.662634    
b16          -8.50724    8.21620  -1.035 0.300477    
b17          -3.10802    6.17666  -0.503 0.614835    
b18          -9.18966    8.21639  -1.118 0.263379    
b19          -2.65637    6.18879  -0.429 0.667763    
b20          -7.84753    8.23873  -0.953 0.340840    
b21          -1.84129    6.20003  -0.297 0.766482    
b22          -7.00131    8.23545  -0.850 0.395250    
b23          -6.38203    6.19662  -1.030 0.303052    
b24          -7.85251    8.24157  -0.953 0.340700    
b25           0.46177    6.19973   0.074 0.940627    
b26         -10.03733    8.24315  -1.218 0.223360    
b27          -2.70505    6.20029  -0.436 0.662637    
b28          -7.84394    8.24294  -0.952 0.341308    
b29          -1.24840    6.19897  -0.201 0.840396    
b30         -10.56193    8.23931  -1.282 0.199886    
b31          -2.67565    6.19041  -0.432 0.665580    
b32          -9.73099    8.21872  -1.184 0.236418    
b33          -4.01934    6.17853  -0.651 0.515351    
b34          -7.78586    8.21851  -0.947 0.343462    
b35          -0.36608    6.19000  -0.059 0.952840    
b36         -10.89112    8.23849  -1.322 0.186181    
b37           0.40635    6.19733   0.066 0.947722    
b38          -9.79346    8.23913  -1.189 0.234583    
b39          -6.70311    6.20202  -1.081 0.279794    
b40          -6.29250    8.22011  -0.766 0.443978    
b41          -4.23276    6.17909  -0.685 0.493338    
b42          -8.07016    8.21856  -0.982 0.326133    
b43          -4.26357    6.19003  -0.689 0.490966    
b44         -11.91024    8.23842  -1.446 0.148270    
b45          -2.32153    6.19708  -0.375 0.707948    
b46         -11.27433    8.23847  -1.368 0.171163    
b47          -3.55502    6.19006  -0.574 0.565760    
b48         -11.57315    8.21857  -1.408 0.159087    
b49          -1.42938    6.17848  -0.231 0.817045    
b50         -10.33559    8.21849  -1.258 0.208542    
b51          -4.59499    6.18998  -0.742 0.457893    
b52          -9.84720    8.23842  -1.195 0.231985    
b53          -1.11257    6.19708  -0.180 0.857521    
b54         -11.55272    8.23848  -1.402 0.160836    
b55           1.60704    6.19006   0.260 0.795161    
b56         -11.27484    8.21857  -1.372 0.170110    
b57          -5.50110    6.17848  -0.890 0.373275    
b58          -9.15234    8.21851  -1.114 0.265446    
b59          -6.73694    6.18999  -1.088 0.276443    
b60          -8.04305    8.23844  -0.976 0.328929    
b61          -3.93120    6.19708  -0.634 0.525848    
b62          -8.02259    8.23848  -0.974 0.330164    
b63          -3.33849    6.19005  -0.539 0.589661    
b64         -11.32159    8.21857  -1.378 0.168345    
b65          -3.83453    6.17849  -0.621 0.534849    
b66         -10.10761    8.21852  -1.230 0.218757    
b67          -2.01208    6.19001  -0.325 0.745142    
b68         -11.09871    8.23845  -1.347 0.177927    
b69          -5.31175    6.19709  -0.857 0.391374    
b70          -8.14453    8.23848  -0.989 0.322866    
b71          -4.11966    6.19005  -0.666 0.505716    
b72          -7.30074    8.21857  -0.888 0.374372    
b73          -1.76721    6.17849  -0.286 0.774859    
b74         -10.81061    8.21853  -1.315 0.188384    
b75          -1.85645    6.19002  -0.300 0.764248    
b76         -10.20731    8.23846  -1.239 0.215358    
b77           2.25854    6.19709   0.364 0.715523    
b78         -11.94724    8.23848  -1.450 0.147017    
b79          -1.72342    6.19006  -0.278 0.780694    
b80         -11.40605    8.21859  -1.388 0.165194    
b81          -2.28111    6.17855  -0.369 0.711982    
b82          -8.63066    8.21870  -1.050 0.293667    
b83          -4.66789    6.19049  -0.754 0.450828    
b84          -8.88475    8.23841  -1.078 0.280837    
b85          -4.80785    6.19707  -0.776 0.437856    
b86          -8.12002    8.23846  -0.986 0.324323    
b87           0.05247    6.19004   0.008 0.993237    
b88         -10.94922    8.21856  -1.332 0.182783    
b89          -3.07816    6.17850  -0.498 0.618342    
b90          -9.24824    8.21855  -1.125 0.260473    
b91          -1.50981    6.19005  -0.244 0.807303    
b92         -13.54930    8.23851  -1.645 0.100053    
b93           1.50905    6.19719   0.244 0.807615    
b94         -12.38675    8.23872  -1.503 0.132722    
b95          -4.88248    6.19058  -0.789 0.430295    
b96          -8.81428    8.22005  -1.072 0.283595    
b97          -5.95968    6.18228  -0.964 0.335054    
b98          -8.94226    8.21766  -1.088 0.276524    
b99          -6.10239    6.18956  -0.986 0.324180    
b100         -6.67638    8.23817  -0.810 0.417703    
b101         -2.60414    6.19697  -0.420 0.674321    
b102         -8.07181    8.23841  -0.980 0.327201    
b103         -3.74110    6.19000  -0.604 0.545595    
b104         -8.46081    8.21854  -1.029 0.303261    
b105         -0.89759    6.17849  -0.145 0.884494    
b106        -11.46469    8.21856  -1.395 0.163030    
b107          1.79858    6.19005   0.291 0.771389    
b108        -11.39482    8.23848  -1.383 0.166634    
b109         -2.63038    6.19709  -0.424 0.671236    
b110         -9.55348    8.23847  -1.160 0.246210    
b111         -6.60353    6.19002  -1.067 0.286067    
b112         -8.26760    8.21854  -1.006 0.314436    
b113         -2.53854    6.17849  -0.411 0.681172    
b114         -8.46949    8.21857  -1.031 0.302766    
b115         -2.58311    6.19007  -0.417 0.676462    
b116        -12.66041    8.23853  -1.537 0.124366    
b117         -0.81757    6.19718  -0.132 0.895044    
b118        -13.03880    8.23872  -1.583 0.113514    
b119         -0.55019    6.19061  -0.089 0.929181    
b120        -10.16919    8.22032  -1.237 0.216064    
b121         -2.86250    6.18442  -0.463 0.643470    
b122         -7.55442    8.24042  -0.917 0.359278    
b123        -13.60627    6.43686  -2.114 0.034537 *  
b124         39.50385   89.86569   0.440 0.660238    
b125        -55.68804   28.15122  -1.978 0.047915 *  
b126        -10.49220    8.37343  -1.253 0.210200    
b127         -5.36479    6.21082  -0.864 0.387713    
b128         -6.53651    8.22776  -0.794 0.426940    
b129         -4.35496    6.19368  -0.703 0.481978    
b130         -6.81849    8.23984  -0.828 0.407957    
b131         -7.02806    6.19767  -1.134 0.256807    
b132         -7.80454    8.23868  -0.947 0.343489    
b133         -4.23241    6.19009  -0.684 0.494143    
b134        -12.71403    8.21856  -1.547 0.121872    
b135         -4.86286    6.17850  -0.787 0.431250    
b136         -9.70863    8.21858  -1.181 0.237489    
b137         -5.14160    6.19006  -0.831 0.406192    
b138         -9.64788    8.23848  -1.171 0.241575    
b139          0.88678    6.19707   0.143 0.886215    
b140         -9.94440    8.23843  -1.207 0.227410    
b141         -2.92734    6.18997  -0.473 0.636274    
b142        -11.36880    8.21850  -1.383 0.166574    
b143         -2.98716    6.17847  -0.483 0.628758    
b144        -10.11952    8.21857  -1.231 0.218217    
b145         -0.02785    6.19006  -0.004 0.996410    
b146        -10.41268    8.23847  -1.264 0.206269    
b147         -5.51685    6.19706  -0.890 0.373344    
b148         -7.46282    8.23842  -0.906 0.365017    
b149         -2.78316    6.18996  -0.450 0.652983    
b150         -8.63814    8.21850  -1.051 0.293236    
b151         -3.40856    6.17852  -0.552 0.581171    
b152        -11.61418    8.21877  -1.413 0.157625    
b153         -5.07327    6.19340  -0.819 0.412711    
b154         -8.65951    8.23886  -1.051 0.293238    
b155         -4.71021    6.19739  -0.760 0.447240    
b156         -8.67734    8.23845  -1.053 0.292221    
b157         -4.17823    6.18995  -0.675 0.499678    
b158         -8.57091    8.21847  -1.043 0.297008    
b159         -1.61336    6.17845  -0.261 0.793996    
b160        -12.75435    8.21856  -1.552 0.120694    
b161         -4.35539    6.19005  -0.704 0.481679    
b162         -7.99186    8.23846  -0.970 0.332019    
b163         -1.90542    6.19704  -0.307 0.758485    
b164        -11.46125    8.23839  -1.391 0.164171    
b165         -2.72361    6.18992  -0.440 0.659933    
b166        -10.65867    8.21845  -1.297 0.194666    
b167         -5.32198    6.17844  -0.861 0.389034    
b168        -10.88522    8.21855  -1.324 0.185354    
b169         -2.36208    6.19004  -0.382 0.702765    
b170        -11.28478    8.23845  -1.370 0.170766    
b171         -4.21015    6.19701  -0.679 0.496898    
b172         -8.07139    8.23833  -0.980 0.327221    
b173         -6.34992    6.18980  -1.026 0.304959    
b174         -8.38732    8.21826  -1.021 0.307463    
b175         -2.39709    6.17822  -0.388 0.698024    
b176         -9.01380    8.21718  -1.097 0.272671    
b177          0.37709    6.18704   0.061 0.951400    
b178        -12.29019    8.23200  -1.493 0.135450    
b179         -3.61571    6.18634  -0.584 0.558909    
b180         -5.25677    8.23177  -0.639 0.523089    
b181         -4.63261    6.30346  -0.735 0.462386    
b182         -6.99857    8.24725  -0.849 0.396112    
b183         -3.11153    6.18988  -0.503 0.615192    
b184         -8.68275    8.22297  -1.056 0.291013    
b185         -0.69897    6.19192  -0.113 0.910123    
b186         -8.76865    8.23916  -1.064 0.287215    
b187         -5.01179    6.19724  -0.809 0.418685    
b188         -9.21895    8.23972  -1.119 0.263214    
b189          0.36385    6.18954   0.059 0.953124    
b190        -11.75917    8.21693  -1.431 0.152411    
b191         -0.28451    6.17848  -0.046 0.963272    
b192        -13.20458    8.21888  -1.607 0.108146    
b193         -1.63945    6.19128  -0.265 0.791164    
b194        -12.52114    8.24413  -1.519 0.128821    
b195         -1.95163    6.19738  -0.315 0.752830    
b196        -10.10406    8.23842  -1.226 0.220034    
b197          0.48664    6.18984   0.079 0.937335    
b198         -9.35527    8.21831  -1.138 0.254983    
b199         -2.21175    6.17828  -0.358 0.720354    
b200         -9.03548    8.21874  -1.099 0.271610    
b201         -4.29791    6.18990  -0.694 0.487471    
b202         -8.08931    8.23834  -0.982 0.326149    
b203         -1.76262    6.19695  -0.284 0.776079    
b204        -10.35033    8.23838  -1.256 0.208994    
b205         -2.88593    6.18983  -0.466 0.641047    
b206         -9.82811    8.21862  -1.196 0.231768    
b207          2.68290    6.17843   0.434 0.664119    
b208        -12.18188    8.21849  -1.482 0.138280    
b209         -2.48725    6.18989  -0.402 0.687815    
b210         -9.10211    8.23811  -1.105 0.269218    
b211         -0.80814    6.19630  -0.130 0.896232    
b212         -9.93381    8.23674  -1.206 0.227810    
b213         -1.73324    6.18684  -0.280 0.779365    
b214         -9.75673    8.21293  -1.188 0.234850    
b215         -5.11318    6.19706  -0.825 0.409321    
b216        -11.13492    8.21504  -1.355 0.175287    
b217         -3.68355    6.18839  -0.595 0.551689    
b218         -9.32257    8.23747  -1.132 0.257755    
b219         -0.19563    6.19685  -0.032 0.974815    
b220         -8.32903    8.23811  -1.011 0.312005    
b221         -3.21785    6.18969  -0.520 0.603155    
b222         -9.20315    8.21849  -1.120 0.262801    
b223         -2.56888    6.17855  -0.416 0.677578    
b224         -9.83574    8.21851  -1.197 0.231399    
b225         -3.35485    6.19009  -0.542 0.587841    
b226         -8.52779    8.23836  -1.035 0.300613    
b227         -5.38108    6.19689  -0.868 0.385207    
b228         -8.56135    8.23849  -1.039 0.298723    
b229         -0.65878    6.18961  -0.106 0.915240    
b230        -11.22783    8.21789  -1.366 0.171862    
b231         -0.43254    6.17774  -0.070 0.944182    
b232        -10.40793    8.21841  -1.266 0.205370    
b233         -0.69806    6.19237  -0.113 0.910245    
b234        -10.50357    8.23864  -1.275 0.202346    
b235         -0.85491    6.19558  -0.138 0.890251    
b236         -9.86962    8.23457  -1.199 0.230706    
b237         -1.54189    6.18347  -0.249 0.803086    
b238         -9.56672    8.22139  -1.164 0.244577    
b239         -4.53799    6.19058  -0.733 0.463533    
b240         -8.67283    8.22434  -1.055 0.291645    
b241         -6.48137    6.19066  -1.047 0.295124    
b242         -4.79211    8.25266  -0.581 0.561463    
b243         -0.79304    6.19645  -0.128 0.898163    
b244        -11.11116    8.24210  -1.348 0.177634    
b245         -5.16317    6.21628  -0.831 0.406211    
b246         -9.32460    8.23998  -1.132 0.257797    
b247         -3.36841    6.20069  -0.543 0.586974    
b248         -8.00127    8.22338  -0.973 0.330563    
b249         -2.83998    6.19688  -0.458 0.646746    
b250         -7.23859    8.23882  -0.879 0.379625    
b251         -4.96681    6.18062  -0.804 0.421627    
b252         -7.77097    8.22540  -0.945 0.344790    
b253          0.44949    6.19957   0.073 0.942202    
b254         13.44695   14.24249   0.944 0.345102    
b255        -36.04459   20.90485  -1.724 0.084675 .  
b256         -7.16349    8.39672  -0.853 0.393592    
b257         -3.19524    6.23123  -0.513 0.608109    
b258         -7.82109    8.24706  -0.948 0.342957    
b259         -5.20122    6.19183  -0.840 0.400906    
b260         -6.75086    8.21479  -0.822 0.411199    
b261         -5.82119    6.14734  -0.947 0.343673    
b262         -1.64473    3.24467  -0.507 0.612227    
b263         11.33526   87.41317   0.130 0.896825    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 4.708 on 44643 degrees of freedom
  (4601 observations deleted due to missingness)
Multiple R-squared:  0.7263,	Adjusted R-squared:  0.7246 
F-statistic: 430.8 on 275 and 44643 DF,  p-value: < 2.2e-16

> # Ottawa
> summary(lms[[2]])

Call:
lm(formula = "mean_temp~.", data = data[row_ids[, k], x_cols])

Residuals:
     Min       1Q   Median       3Q      Max 
-21.7435  -3.0089  -0.0256   3.0458  18.4743 

Coefficients: (1 not defined because of singularities)
             Estimate Std. Error t value Pr(>|t|)    
(Intercept)   2.08099    8.39756   0.248  0.80428    
s1          -34.57778    3.49849  -9.884  < 2e-16 ***
s2           -1.04915    0.03032 -34.608  < 2e-16 ***
s3           -1.26854    0.11465 -11.064  < 2e-16 ***
s4            0.16213    0.03026   5.358 8.47e-08 ***
s5            0.02347    0.03441   0.682  0.49524    
s6            0.09158    0.03027   3.026  0.00248 ** 
c1          -20.61763    0.68037 -30.303  < 2e-16 ***
c2           -0.74823    0.03041 -24.602  < 2e-16 ***
c3           -0.66061    0.07796  -8.474  < 2e-16 ***
c4           -0.05035    0.03029  -1.662  0.09642 .  
c5           -0.25325    0.03816  -6.637 3.24e-11 ***
c6            0.16986    0.03026   5.614 1.99e-08 ***
b1          -90.54959   55.78823  -1.623  0.10458    
b2          -45.63961    9.17577  -4.974 6.58e-07 ***
b3           58.52931   12.25746   4.775 1.80e-06 ***
b4          -54.29129    9.19308  -5.906 3.54e-09 ***
b5           59.57644   12.32052   4.836 1.33e-06 ***
b6          -52.16514    9.20233  -5.669 1.45e-08 ***
b7           60.35692   12.32480   4.897 9.75e-07 ***
b8          -54.04550    9.20584  -5.871 4.37e-09 ***
b9           58.26224   12.33622   4.723 2.33e-06 ***
b10         -53.83164    9.21649  -5.841 5.23e-09 ***
b11          61.42531   12.34257   4.977 6.49e-07 ***
b12         -53.93188    9.21687  -5.851 4.90e-09 ***
b13          60.92381   12.33741   4.938 7.91e-07 ***
b14         -54.33660    9.20709  -5.902 3.62e-09 ***
b15          60.59359   12.32813   4.915 8.90e-07 ***
b16         -53.92282    9.20695  -5.857 4.75e-09 ***
b17          61.64249   12.33748   4.996 5.86e-07 ***
b18         -54.85120    9.21768  -5.951 2.69e-09 ***
b19          63.14844   12.34615   5.115 3.15e-07 ***
b20         -53.20112    9.22270  -5.769 8.05e-09 ***
b21          59.87499   12.35722   4.845 1.27e-06 ***
b22         -52.55922    9.21954  -5.701 1.20e-08 ***
b23          60.43752   12.34614   4.895 9.85e-07 ***
b24         -52.57149    9.21996  -5.702 1.19e-08 ***
b25          61.00461   12.34653   4.941 7.80e-07 ***
b26         -53.69587    9.21986  -5.824 5.78e-09 ***
b27          62.65911   12.34550   5.075 3.88e-07 ***
b28         -56.14234    9.21807  -6.090 1.13e-09 ***
b29          64.39731   12.33875   5.219 1.81e-07 ***
b30         -56.61770    9.20786  -6.149 7.87e-10 ***
b31          59.33852   12.32935   4.813 1.49e-06 ***
b32         -55.22123    9.20774  -5.997 2.02e-09 ***
b33          58.17965   12.33838   4.715 2.42e-06 ***
b34         -53.14612    9.21762  -5.766 8.18e-09 ***
b35          61.15741   12.34400   4.954 7.28e-07 ***
b36         -53.14473    9.21766  -5.766 8.19e-09 ***
b37          57.59218   12.33848   4.668 3.05e-06 ***
b38         -53.91105    9.20779  -5.855 4.80e-09 ***
b39          59.23106   12.32931   4.804 1.56e-06 ***
b40         -51.58807    9.20773  -5.603 2.12e-08 ***
b41          59.61956   12.33838   4.832 1.36e-06 ***
b42         -54.15337    9.21762  -5.875 4.26e-09 ***
b43          64.30396   12.34401   5.209 1.90e-07 ***
b44         -55.93506    9.21766  -6.068 1.30e-09 ***
b45          60.76896   12.33848   4.925 8.46e-07 ***
b46         -51.98576    9.20779  -5.646 1.65e-08 ***
b47          57.54776   12.32932   4.668 3.06e-06 ***
b48         -52.43253    9.20774  -5.694 1.25e-08 ***
b49          61.64322   12.33839   4.996 5.87e-07 ***
b50         -52.77280    9.21763  -5.725 1.04e-08 ***
b51          60.52336   12.34401   4.903 9.47e-07 ***
b52         -53.99303    9.21767  -5.858 4.73e-09 ***
b53          62.09701   12.33848   5.033 4.85e-07 ***
b54         -52.81604    9.20780  -5.736 9.75e-09 ***
b55          59.37391   12.32933   4.816 1.47e-06 ***
b56         -52.46831    9.20775  -5.698 1.22e-08 ***
b57          58.50725   12.33841   4.742 2.12e-06 ***
b58         -55.29595    9.21764  -5.999 2.00e-09 ***
b59          58.91008   12.34402   4.772 1.83e-06 ***
b60         -53.49613    9.21767  -5.804 6.53e-09 ***
b61          62.94710   12.33848   5.102 3.38e-07 ***
b62         -54.58990    9.20780  -5.929 3.07e-09 ***
b63          59.48309   12.32933   4.825 1.41e-06 ***
b64         -52.78791    9.20776  -5.733 9.93e-09 ***
b65          64.71462   12.33842   5.245 1.57e-07 ***
b66         -53.86036    9.21765  -5.843 5.15e-09 ***
b67          61.48220   12.34402   4.981 6.36e-07 ***
b68         -52.54451    9.21769  -5.700 1.20e-08 ***
b69          56.97671   12.33850   4.618 3.89e-06 ***
b70         -51.50041    9.20780  -5.593 2.24e-08 ***
b71          60.05157   12.32934   4.871 1.12e-06 ***
b72         -54.76325    9.20776  -5.948 2.74e-09 ***
b73          61.92126   12.33843   5.019 5.22e-07 ***
b74         -54.88970    9.21765  -5.955 2.62e-09 ***
b75          58.61314   12.34403   4.748 2.06e-06 ***
b76         -55.38501    9.21767  -6.009 1.89e-09 ***
b77          61.07797   12.33848   4.950 7.44e-07 ***
b78         -53.61239    9.20780  -5.822 5.83e-09 ***
b79          60.16157   12.32934   4.880 1.07e-06 ***
b80         -54.62727    9.20777  -5.933 3.00e-09 ***
b81          60.95952   12.33844   4.941 7.81e-07 ***
b82         -55.48561    9.21766  -6.019 1.76e-09 ***
b83          61.10808   12.34404   4.950 7.43e-07 ***
b84         -54.13502    9.21767  -5.873 4.31e-09 ***
b85          61.51824   12.33848   4.986 6.19e-07 ***
b86         -51.25679    9.20780  -5.567 2.61e-08 ***
b87          60.75058   12.32935   4.927 8.36e-07 ***
b88         -54.82515    9.20778  -5.954 2.63e-09 ***
b89          64.33458   12.33845   5.214 1.85e-07 ***
b90         -56.93442    9.21766  -6.177 6.60e-10 ***
b91          56.36285   12.34404   4.566 4.98e-06 ***
b92         -52.66451    9.21767  -5.713 1.11e-08 ***
b93          58.33474   12.33848   4.728 2.28e-06 ***
b94         -53.96812    9.20780  -5.861 4.63e-09 ***
b95          59.47601   12.32935   4.824 1.41e-06 ***
b96         -54.82451    9.20778  -5.954 2.63e-09 ***
b97          62.73519   12.33846   5.085 3.70e-07 ***
b98         -54.61566    9.21766  -5.925 3.14e-09 ***
b99          60.36568   12.34404   4.890 1.01e-06 ***
b100        -52.69432    9.21767  -5.717 1.09e-08 ***
b101         58.37319   12.33848   4.731 2.24e-06 ***
b102        -53.74543    9.20780  -5.837 5.35e-09 ***
b103         58.45165   12.32935   4.741 2.13e-06 ***
b104        -54.62627    9.20778  -5.933 3.00e-09 ***
b105         60.96170   12.33846   4.941 7.81e-07 ***
b106        -54.44269    9.21766  -5.906 3.52e-09 ***
b107         63.32542   12.34401   5.130 2.91e-07 ***
b108        -55.11582    9.21765  -5.979 2.26e-09 ***
b109         58.72810   12.33861   4.760 1.94e-06 ***
b110        -54.20192    9.20784  -5.887 3.97e-09 ***
b111         60.86134   12.32938   4.936 7.99e-07 ***
b112        -53.60527    9.20782  -5.822 5.86e-09 ***
b113         60.55399   12.33862   4.908 9.25e-07 ***
b114        -54.35299    9.21839  -5.896 3.75e-09 ***
b115         60.47011   12.34409   4.899 9.68e-07 ***
b116        -52.88712    9.21768  -5.738 9.66e-09 ***
b117         58.79945   12.33847   4.766 1.89e-06 ***
b118        -51.67158    9.20779  -5.612 2.01e-08 ***
b119         57.71026   12.32935   4.681 2.87e-06 ***
b120        -50.45115    9.20779  -5.479 4.29e-08 ***
b121         62.05272   12.33848   5.029 4.94e-07 ***
b122        -52.66494    9.21767  -5.713 1.11e-08 ***
b123         60.31393   12.34404   4.886 1.03e-06 ***
b124        -54.64842    9.21767  -5.929 3.07e-09 ***
b125         63.37862   12.33846   5.137 2.81e-07 ***
b126        -55.47639    9.20781  -6.025 1.70e-09 ***
b127         62.91548   12.32939   5.103 3.36e-07 ***
b128        -53.98774    9.20779  -5.863 4.57e-09 ***
b129         64.45793   12.33849   5.224 1.76e-07 ***
b130        -53.73947    9.21771  -5.830 5.58e-09 ***
b131         62.67828   12.34423   5.078 3.84e-07 ***
b132        -55.79200    9.21769  -6.053 1.43e-09 ***
b133         62.42535   12.33845   5.059 4.22e-07 ***
b134        -51.94843    9.20779  -5.642 1.69e-08 ***
b135         58.98395   12.32935   4.784 1.72e-06 ***
b136        -54.81369    9.20780  -5.953 2.65e-09 ***
b137         62.48091   12.33848   5.064 4.12e-07 ***
b138        -53.96556    9.21767  -5.855 4.81e-09 ***
b139         63.50549   12.34404   5.145 2.69e-07 ***
b140        -56.45690    9.21766  -6.125 9.15e-10 ***
b141         60.36447   12.33844   4.892 9.99e-07 ***
b142        -51.88007    9.20778  -5.634 1.77e-08 ***
b143         60.42147   12.32934   4.901 9.58e-07 ***
b144        -52.51062    9.20780  -5.703 1.19e-08 ***
b145         59.83016   12.33848   4.849 1.24e-06 ***
b146        -52.19650    9.21767  -5.663 1.50e-08 ***
b147         61.50566   12.34403   4.983 6.29e-07 ***
b148        -54.65014    9.21766  -5.929 3.07e-09 ***
b149         60.11798   12.33843   4.872 1.11e-06 ***
b150        -53.56562    9.20777  -5.817 6.01e-09 ***
b151         62.72767   12.32934   5.088 3.64e-07 ***
b152        -54.88617    9.20780  -5.961 2.53e-09 ***
b153         61.47250   12.33848   4.982 6.31e-07 ***
b154        -54.61445    9.21767  -5.925 3.14e-09 ***
b155         62.69990   12.34403   5.079 3.80e-07 ***
b156        -53.94933    9.21765  -5.853 4.86e-09 ***
b157         60.82968   12.33842   4.930 8.25e-07 ***
b158        -54.21789    9.20777  -5.888 3.93e-09 ***
b159         61.61626   12.32933   4.998 5.83e-07 ***
b160        -53.14483    9.20780  -5.772 7.89e-09 ***
b161         61.46998   12.33848   4.982 6.32e-07 ***
b162        -53.77561    9.21767  -5.834 5.45e-09 ***
b163         59.79411   12.34402   4.844 1.28e-06 ***
b164        -52.06430    9.21765  -5.648 1.63e-08 ***
b165         58.27326   12.33841   4.723 2.33e-06 ***
b166        -51.39392    9.20776  -5.582 2.40e-08 ***
b167         59.21762   12.32933   4.803 1.57e-06 ***
b168        -54.60313    9.20780  -5.930 3.05e-09 ***
b169         62.89963   12.33848   5.098 3.45e-07 ***
b170        -52.79058    9.21767  -5.727 1.03e-08 ***
b171         60.72437   12.34401   4.919 8.71e-07 ***
b172        -54.69479    9.21764  -5.934 2.98e-09 ***
b173         63.57032   12.33840   5.152 2.58e-07 ***
b174        -53.95978    9.20775  -5.860 4.65e-09 ***
b175         62.68463   12.32932   5.084 3.71e-07 ***
b176        -56.74638    9.20780  -6.163 7.20e-10 ***
b177         63.47494   12.33848   5.144 2.69e-07 ***
b178        -54.70933    9.21767  -5.935 2.95e-09 ***
b179         60.85978   12.34401   4.930 8.24e-07 ***
b180        -54.07467    9.21763  -5.866 4.48e-09 ***
b181         62.11486   12.33838   5.034 4.81e-07 ***
b182        -53.85727    9.20775  -5.849 4.97e-09 ***
b183         63.99595   12.32931   5.191 2.11e-07 ***
b184        -57.25411    9.20779  -6.218 5.08e-10 ***
b185         64.04205   12.33848   5.190 2.11e-07 ***
b186        -55.08399    9.21767  -5.976 2.30e-09 ***
b187         60.96006   12.34400   4.938 7.90e-07 ***
b188        -53.30855    9.21763  -5.783 7.37e-09 ***
b189         63.38247   12.33837   5.137 2.80e-07 ***
b190        -53.65041    9.20774  -5.827 5.69e-09 ***
b191         60.87862   12.32930   4.938 7.93e-07 ***
b192        -53.04136    9.20779  -5.760 8.44e-09 ***
b193         62.15843   12.33847   5.038 4.73e-07 ***
b194        -54.66185    9.21766  -5.930 3.05e-09 ***
b195         64.15572   12.34399   5.197 2.03e-07 ***
b196        -56.57096    9.21762  -6.137 8.46e-10 ***
b197         65.70825   12.33835   5.326 1.01e-07 ***
b198        -55.42129    9.20773  -6.019 1.77e-09 ***
b199         64.10590   12.32929   5.199 2.01e-07 ***
b200        -54.68353    9.20779  -5.939 2.89e-09 ***
b201         63.16972   12.33847   5.120 3.07e-07 ***
b202        -55.46499    9.21766  -6.017 1.79e-09 ***
b203         63.62899   12.34398   5.155 2.55e-07 ***
b204        -54.73153    9.21761  -5.938 2.91e-09 ***
b205         65.29263   12.33833   5.292 1.22e-07 ***
b206        -53.54624    9.20772  -5.815 6.09e-09 ***
b207         60.53704   12.32928   4.910 9.14e-07 ***
b208        -54.63592    9.20778  -5.934 2.98e-09 ***
b209         62.04934   12.33846   5.029 4.95e-07 ***
b210        -54.35742    9.21765  -5.897 3.72e-09 ***
b211         59.53412   12.34396   4.823 1.42e-06 ***
b212        -52.22918    9.21760  -5.666 1.47e-08 ***
b213         64.23329   12.33832   5.206 1.94e-07 ***
b214        -54.71571    9.20771  -5.942 2.83e-09 ***
b215         60.76081   12.32927   4.928 8.33e-07 ***
b216        -52.67637    9.20778  -5.721 1.07e-08 ***
b217         62.02000   12.33845   5.027 5.01e-07 ***
b218        -55.35288    9.21765  -6.005 1.93e-09 ***
b219         66.52929   12.34395   5.390 7.09e-08 ***
b220        -53.71136    9.21759  -5.827 5.68e-09 ***
b221         64.94670   12.33830   5.264 1.42e-07 ***
b222        -52.49473    9.20770  -5.701 1.20e-08 ***
b223         64.25528   12.32925   5.212 1.88e-07 ***
b224        -55.04940    9.20777  -5.979 2.27e-09 ***
b225         62.19179   12.33845   5.040 4.66e-07 ***
b226        -50.41747    9.21764  -5.470 4.53e-08 ***
b227         64.16102   12.34394   5.198 2.03e-07 ***
b228        -53.67290    9.21758  -5.823 5.82e-09 ***
b229         60.67457   12.33828   4.918 8.79e-07 ***
b230        -52.27048    9.20769  -5.677 1.38e-08 ***
b231         62.14646   12.32924   5.041 4.66e-07 ***
b232        -53.41866    9.20777  -5.801 6.61e-09 ***
b233         62.10106   12.33844   5.033 4.84e-07 ***
b234        -51.41115    9.21763  -5.577 2.45e-08 ***
b235         64.28767   12.34392   5.208 1.92e-07 ***
b236        -53.07735    9.21757  -5.758 8.55e-09 ***
b237         63.20764   12.33826   5.123 3.02e-07 ***
b238        -53.13332    9.20767  -5.771 7.95e-09 ***
b239         63.39384   12.32922   5.142 2.73e-07 ***
b240        -55.12691    9.20776  -5.987 2.15e-09 ***
b241         63.22379   12.33843   5.124 3.00e-07 ***
b242        -55.40614    9.21763  -6.011 1.86e-09 ***
b243         68.26960   12.34391   5.531 3.21e-08 ***
b244        -54.92775    9.21755  -5.959 2.55e-09 ***
b245         63.43356   12.33823   5.141 2.74e-07 ***
b246        -51.82613    9.20766  -5.629 1.83e-08 ***
b247         66.38039   12.32921   5.384 7.32e-08 ***
b248        -53.21404    9.20775  -5.779 7.55e-09 ***
b249         63.73518   12.33841   5.166 2.41e-07 ***
b250        -53.93551    9.21762  -5.851 4.91e-09 ***
b251         60.28528   12.34389   4.884 1.04e-06 ***
b252        -51.99117    9.21754  -5.640 1.71e-08 ***
b253         59.01250   12.33820   4.783 1.73e-06 ***
b254        -49.34114    9.20764  -5.359 8.42e-08 ***
b255         62.58216   12.32915   5.076 3.87e-07 ***
b256        -51.48056    9.20769  -5.591 2.27e-08 ***
b257         63.45158   12.33819   5.143 2.72e-07 ***
b258        -53.46102    9.21744  -5.800 6.67e-09 ***
b259         63.78772   12.34578   5.167 2.39e-07 ***
b260        -53.31613    9.21801  -5.784 7.34e-09 ***
b261         61.13234   12.33587   4.956 7.23e-07 ***
b262        -54.15165    9.20659  -5.882 4.08e-09 ***
b263         66.47261   12.32115   5.395 6.88e-08 ***
b264        -53.22998    9.20841  -5.781 7.49e-09 ***
b265         64.94843   12.33191   5.267 1.39e-07 ***
b266        -52.12175    9.22630  -5.649 1.62e-08 ***
b267         63.32685   12.31616   5.142 2.73e-07 ***
b268        -52.69834    9.27390  -5.682 1.34e-08 ***
b269         66.55091   12.17053   5.468 4.57e-08 ***
b270         -8.57742    8.63260  -0.994  0.32042    
b271               NA         NA      NA       NA    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 4.72 on 48393 degrees of freedom
  (478 observations deleted due to missingness)
Multiple R-squared:  0.8529,	Adjusted R-squared:  0.8521 
F-statistic: 995.1 on 282 and 48393 DF,  p-value: < 2.2e-16

> # Toronto
> summary(lms[[3]])

Call:
lm(formula = "mean_temp~.", data = data[row_ids[, k], x_cols])

Residuals:
     Min       1Q   Median       3Q      Max 
-20.4376  -2.6888   0.0019   2.7838  16.0227 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)   12.79479    3.04448   4.203 2.64e-05 ***
s1             3.37374    1.73252   1.947 0.051503 .  
s2            -0.10786    0.02403  -4.489 7.17e-06 ***
s3             0.01465    0.06058   0.242 0.808868    
s4             0.09203    0.02400   3.834 0.000126 ***
s5             0.19382    0.02549   7.604 2.91e-14 ***
s6             0.09858    0.02400   4.107 4.01e-05 ***
c1           -10.64856    0.32155 -33.116  < 2e-16 ***
c2             0.01077    0.02405   0.448 0.654377    
c3             0.27995    0.04160   6.729 1.73e-11 ***
c4             0.02817    0.02400   1.174 0.240512    
c5            -0.07210    0.02647  -2.724 0.006452 ** 
c6             0.16628    0.02400   6.928 4.30e-12 ***
b1           -21.65755    4.48973  -4.824 1.41e-06 ***
b2             9.93635    4.87463   2.038 0.041516 *  
b3           -22.66149    4.17770  -5.424 5.84e-08 ***
b4            10.67491    5.01735   2.128 0.033374 *  
b5           -20.34907    4.13021  -4.927 8.38e-07 ***
b6             9.42594    5.04252   1.869 0.061587 .  
b7           -23.56650    4.11888  -5.722 1.06e-08 ***
b8             9.92813    5.03915   1.970 0.048820 *  
b9           -20.12538    4.11309  -4.893 9.96e-07 ***
b10            9.56629    5.03980   1.898 0.057681 .  
b11          -20.21913    4.11672  -4.911 9.06e-07 ***
b12            8.69082    5.04807   1.722 0.085145 .  
b13          -21.96251    4.11925  -5.332 9.77e-08 ***
b14           12.84859    5.04827   2.545 0.010926 *  
b15          -24.31628    4.11687  -5.906 3.51e-09 ***
b16           10.37635    5.04023   2.059 0.039527 *  
b17          -21.34732    4.11274  -5.191 2.10e-07 ***
b18            9.60273    5.04002   1.905 0.056746 .  
b19          -23.77745    4.11667  -5.776 7.69e-09 ***
b20           11.19276    5.04813   2.217 0.026613 *  
b21          -21.68651    4.11926  -5.265 1.41e-07 ***
b22            9.37325    5.04830   1.857 0.063357 .  
b23          -21.45883    4.11689  -5.212 1.87e-07 ***
b24            9.15791    5.04025   1.817 0.069229 .  
b25          -24.82476    4.11275  -6.036 1.59e-09 ***
b26           11.18181    5.04005   2.219 0.026518 *  
b27          -22.67533    4.11669  -5.508 3.64e-08 ***
b28           10.78406    5.04816   2.136 0.032664 *  
b29          -24.02067    4.11928  -5.831 5.53e-09 ***
b30           12.61706    5.04832   2.499 0.012448 *  
b31          -24.48910    4.11690  -5.948 2.72e-09 ***
b32           11.50960    5.04027   2.284 0.022403 *  
b33          -26.46444    4.11277  -6.435 1.25e-10 ***
b34           11.76807    5.04007   2.335 0.019552 *  
b35          -26.33467    4.11672  -6.397 1.60e-10 ***
b36           11.47118    5.04818   2.272 0.023070 *  
b37          -22.64091    4.11929  -5.496 3.89e-08 ***
b38           10.96633    5.04834   2.172 0.029840 *  
b39          -20.47396    4.11692  -4.973 6.61e-07 ***
b40            8.68129    5.04029   1.722 0.085006 .  
b41          -21.39064    4.11279  -5.201 1.99e-07 ***
b42           10.39654    5.04010   2.063 0.039139 *  
b43          -23.72210    4.11674  -5.762 8.34e-09 ***
b44           11.74550    5.04821   2.327 0.019986 *  
b45          -23.26297    4.11931  -5.647 1.64e-08 ***
b46           11.52105    5.04836   2.282 0.022485 *  
b47          -21.93345    4.11693  -5.328 9.99e-08 ***
b48           10.31194    5.04031   2.046 0.040771 *  
b49          -21.37742    4.11281  -5.198 2.02e-07 ***
b50           10.86053    5.04012   2.155 0.031180 *  
b51          -22.98014    4.11675  -5.582 2.39e-08 ***
b52           12.43914    5.04823   2.464 0.013740 *  
b53          -23.70664    4.11933  -5.755 8.71e-09 ***
b54           11.25801    5.04838   2.230 0.025749 *  
b55          -23.45561    4.11695  -5.697 1.22e-08 ***
b56           12.11697    5.04033   2.404 0.016220 *  
b57          -24.48875    4.11282  -5.954 2.63e-09 ***
b58           12.48471    5.04015   2.477 0.013250 *  
b59          -24.01728    4.11677  -5.834 5.44e-09 ***
b60            9.75190    5.04825   1.932 0.053397 .  
b61          -21.22140    4.11934  -5.152 2.59e-07 ***
b62           12.04932    5.04840   2.387 0.017001 *  
b63          -21.47318    4.11696  -5.216 1.84e-07 ***
b64           10.06603    5.04035   1.997 0.045820 *  
b65          -24.50163    4.11284  -5.957 2.58e-09 ***
b66           11.89003    5.04017   2.359 0.018325 *  
b67          -26.01254    4.11679  -6.319 2.66e-10 ***
b68           11.84428    5.04828   2.346 0.018969 *  
b69          -24.59649    4.11936  -5.971 2.37e-09 ***
b70           12.57206    5.04841   2.490 0.012766 *  
b71          -27.29473    4.11697  -6.630 3.39e-11 ***
b72           11.04231    5.04037   2.191 0.028472 *  
b73          -22.36902    4.11285  -5.439 5.39e-08 ***
b74           10.23253    5.04019   2.030 0.042342 *  
b75          -23.84856    4.11681  -5.793 6.95e-09 ***
b76           13.10201    5.04830   2.595 0.009452 ** 
b77          -19.52476    4.11938  -4.740 2.14e-06 ***
b78           11.77878    5.04843   2.333 0.019643 *  
b79          -24.43643    4.11699  -5.936 2.95e-09 ***
b80           11.90871    5.04038   2.363 0.018148 *  
b81          -19.90606    4.11287  -4.840 1.30e-06 ***
b82            9.84723    5.04021   1.954 0.050737 .  
b83          -25.16126    4.11683  -6.112 9.91e-10 ***
b84           15.68554    5.04832   3.107 0.001890 ** 
b85          -23.23671    4.11939  -5.641 1.70e-08 ***
b86           12.34796    5.04845   2.446 0.014452 *  
b87          -25.82847    4.11700  -6.274 3.55e-10 ***
b88           10.41325    5.04040   2.066 0.038837 *  
b89          -24.14565    4.11289  -5.871 4.36e-09 ***
b90           12.43028    5.04023   2.466 0.013658 *  
b91          -28.15154    4.11685  -6.838 8.10e-12 ***
b92           11.84953    5.04834   2.347 0.018918 *  
b93          -23.08591    4.11941  -5.604 2.10e-08 ***
b94           10.38230    5.04847   2.057 0.039736 *  
b95          -23.47556    4.11701  -5.702 1.19e-08 ***
b96           11.89754    5.04042   2.360 0.018257 *  
b97          -25.85981    4.11290  -6.287 3.25e-10 ***
b98           11.74422    5.04025   2.330 0.019805 *  
b99          -22.11669    4.11686  -5.372 7.81e-08 ***
b100          11.14514    5.04836   2.208 0.027271 *  
b101         -20.35833    4.11942  -4.942 7.75e-07 ***
b102           9.71216    5.04848   1.924 0.054387 .  
b103         -21.81363    4.11702  -5.298 1.17e-07 ***
b104          11.49932    5.04043   2.281 0.022527 *  
b105         -22.39053    4.11291  -5.444 5.23e-08 ***
b106          11.36148    5.04027   2.254 0.024191 *  
b107         -24.45689    4.11688  -5.941 2.85e-09 ***
b108          11.91020    5.04838   2.359 0.018317 *  
b109         -21.38722    4.11944  -5.192 2.09e-07 ***
b110          11.91666    5.04850   2.360 0.018257 *  
b111         -22.99725    4.11704  -5.586 2.34e-08 ***
b112          10.87264    5.04046   2.157 0.031004 *  
b113         -21.74305    4.11295  -5.286 1.25e-07 ***
b114          11.64739    5.04036   2.311 0.020846 *  
b115         -21.89239    4.11702  -5.318 1.06e-07 ***
b116          11.87952    5.04875   2.353 0.018628 *  
b117         -20.26105    4.12014  -4.918 8.79e-07 ***
b118          12.80896    5.05042   2.536 0.011208 *  
b119         -23.26616    4.12079  -5.646 1.65e-08 ***
b120          13.51264    5.05081   2.675 0.007467 ** 
b121         -23.57566    4.12094  -5.721 1.06e-08 ***
b122          14.85202    5.05087   2.940 0.003278 ** 
b123         -22.68067    4.12088  -5.504 3.73e-08 ***
b124          12.58760    5.05060   2.492 0.012695 *  
b125         -21.59353    4.12030  -5.241 1.60e-07 ***
b126          10.61804    5.04904   2.103 0.035472 *  
b127         -19.08427    4.11723  -4.635 3.57e-06 ***
b128           9.86504    5.04067   1.957 0.050342 .  
b129         -24.11622    4.11312  -5.863 4.56e-09 ***
b130          10.85988    5.04066   2.154 0.031208 *  
b131         -24.12086    4.11717  -5.859 4.69e-09 ***
b132          13.16086    5.04872   2.607 0.009142 ** 
b133         -21.51725    4.11961  -5.223 1.77e-07 ***
b134          13.14497    5.04868   2.604 0.009226 ** 
b135         -24.08045    4.11710  -5.849 4.97e-09 ***
b136          11.58633    5.04060   2.299 0.021531 *  
b137         -22.21749    4.11309  -5.402 6.63e-08 ***
b138          13.33385    5.04064   2.645 0.008165 ** 
b139         -21.19122    4.11716  -5.147 2.65e-07 ***
b140          10.75510    5.04871   2.130 0.033154 *  
b141         -19.41553    4.11960  -4.713 2.45e-06 ***
b142          10.35136    5.04868   2.050 0.040338 *  
b143         -20.35622    4.11709  -4.944 7.66e-07 ***
b144          12.78887    5.04059   2.537 0.011178 *  
b145         -24.79519    4.11308  -6.028 1.67e-09 ***
b146          13.48650    5.04064   2.676 0.007463 ** 
b147         -20.64814    4.11715  -5.015 5.31e-07 ***
b148          12.82713    5.04871   2.541 0.011066 *  
b149         -21.87238    4.11960  -5.309 1.10e-07 ***
b150          12.78760    5.04867   2.533 0.011316 *  
b151         -21.79134    4.11708  -5.293 1.21e-07 ***
b152          12.79310    5.04058   2.538 0.011151 *  
b153         -22.50856    4.11308  -5.472 4.46e-08 ***
b154          13.39888    5.04064   2.658 0.007859 ** 
b155         -23.32818    4.11715  -5.666 1.47e-08 ***
b156           9.92766    5.04871   1.966 0.049260 *  
b157         -23.08150    4.11959  -5.603 2.12e-08 ***
b158          12.81939    5.04866   2.539 0.011114 *  
b159         -18.88879    4.11707  -4.588 4.49e-06 ***
b160          12.47084    5.04057   2.474 0.013360 *  
b161         -24.24939    4.11307  -5.896 3.75e-09 ***
b162          13.46534    5.04063   2.671 0.007557 ** 
b163         -17.90815    4.11715  -4.350 1.37e-05 ***
b164          12.89365    5.04870   2.554 0.010656 *  
b165         -20.48637    4.11958  -4.973 6.61e-07 ***
b166          13.42724    5.04865   2.660 0.007826 ** 
b167         -23.96171    4.11706  -5.820 5.91e-09 ***
b168          13.15095    5.04056   2.609 0.009082 ** 
b169         -22.13861    4.11306  -5.383 7.37e-08 ***
b170          10.47316    5.04063   2.078 0.037737 *  
b171         -20.49297    4.11714  -4.977 6.46e-07 ***
b172          11.17941    5.04870   2.214 0.026811 *  
b173         -23.56206    4.11957  -5.720 1.07e-08 ***
b174          10.87935    5.04864   2.155 0.031173 *  
b175         -21.51933    4.11705  -5.227 1.73e-07 ***
b176          12.42599    5.04055   2.465 0.013696 *  
b177         -21.53562    4.11306  -5.236 1.65e-07 ***
b178          11.81792    5.04062   2.345 0.019054 *  
b179         -20.14997    4.11714  -4.894 9.90e-07 ***
b180          10.59299    5.04869   2.098 0.035895 *  
b181         -20.61732    4.11957  -5.005 5.61e-07 ***
b182          12.69400    5.04863   2.514 0.011928 *  
b183         -21.09354    4.11704  -5.123 3.01e-07 ***
b184          15.23335    5.04054   3.022 0.002511 ** 
b185         -19.91609    4.11305  -4.842 1.29e-06 ***
b186          11.20029    5.04062   2.222 0.026287 *  
b187         -18.17591    4.11713  -4.415 1.01e-05 ***
b188          10.99638    5.04868   2.178 0.029405 *  
b189         -23.32873    4.11956  -5.663 1.50e-08 ***
b190          13.12887    5.04862   2.600 0.009311 ** 
b191         -21.92672    4.11703  -5.326 1.01e-07 ***
b192          12.27100    5.04053   2.434 0.014917 *  
b193         -22.47968    4.11304  -5.465 4.64e-08 ***
b194          13.00341    5.04061   2.580 0.009890 ** 
b195         -20.09843    4.11712  -4.882 1.05e-06 ***
b196          11.60396    5.04868   2.298 0.021542 *  
b197         -20.31888    4.11955  -4.932 8.15e-07 ***
b198          13.58434    5.04861   2.691 0.007132 ** 
b199         -22.01070    4.11702  -5.346 9.01e-08 ***
b200          13.64282    5.04052   2.707 0.006799 ** 
b201         -23.43231    4.11303  -5.697 1.22e-08 ***
b202          12.23755    5.04060   2.428 0.015194 *  
b203         -20.75001    4.11712  -5.040 4.67e-07 ***
b204          13.54355    5.04867   2.683 0.007307 ** 
b205         -19.62994    4.11954  -4.765 1.89e-06 ***
b206          12.00210    5.04860   2.377 0.017442 *  
b207         -21.97122    4.11701  -5.337 9.50e-08 ***
b208          12.35576    5.04051   2.451 0.014237 *  
b209         -20.77374    4.11302  -5.051 4.41e-07 ***
b210          12.57746    5.04060   2.495 0.012590 *  
b211         -20.88221    4.11711  -5.072 3.95e-07 ***
b212          11.82291    5.04866   2.342 0.019195 *  
b213         -20.35726    4.11953  -4.942 7.77e-07 ***
b214          13.44543    5.04859   2.663 0.007742 ** 
b215         -22.22219    4.11700  -5.398 6.78e-08 ***
b216          14.36132    5.04049   2.849 0.004385 ** 
b217         -23.00678    4.11301  -5.594 2.23e-08 ***
b218          14.78576    5.04059   2.933 0.003355 ** 
b219         -19.49405    4.11710  -4.735 2.20e-06 ***
b220          14.45213    5.04865   2.863 0.004204 ** 
b221         -21.71502    4.11952  -5.271 1.36e-07 ***
b222          12.02416    5.04858   2.382 0.017236 *  
b223         -18.85583    4.11698  -4.580 4.66e-06 ***
b224          11.58567    5.04048   2.299 0.021535 *  
b225         -19.33696    4.11300  -4.701 2.59e-06 ***
b226          12.97348    5.04058   2.574 0.010061 *  
b227         -18.65795    4.11709  -4.532 5.86e-06 ***
b228          13.44636    5.04864   2.663 0.007739 ** 
b229         -19.43682    4.11951  -4.718 2.38e-06 ***
b230          11.82018    5.04856   2.341 0.019220 *  
b231         -18.58716    4.11697  -4.515 6.35e-06 ***
b232          14.16187    5.04047   2.810 0.004961 ** 
b233         -22.46918    4.11299  -5.463 4.70e-08 ***
b234          12.42532    5.04057   2.465 0.013702 *  
b235         -19.48697    4.11709  -4.733 2.22e-06 ***
b236          12.50760    5.04863   2.477 0.013236 *  
b237         -19.59924    4.11950  -4.758 1.96e-06 ***
b238          11.53930    5.04855   2.286 0.022277 *  
b239         -21.39686    4.11696  -5.197 2.03e-07 ***
b240          15.38554    5.04045   3.052 0.002271 ** 
b241         -22.61648    4.11298  -5.499 3.84e-08 ***
b242          14.29405    5.04056   2.836 0.004573 ** 
b243         -22.16704    4.11708  -5.384 7.31e-08 ***
b244          14.36905    5.04862   2.846 0.004427 ** 
b245         -20.70909    4.11949  -5.027 4.99e-07 ***
b246          12.86961    5.04854   2.549 0.010800 *  
b247         -22.08183    4.11694  -5.364 8.19e-08 ***
b248          13.72094    5.04044   2.722 0.006487 ** 
b249         -20.18438    4.11297  -4.907 9.25e-07 ***
b250          12.56835    5.04055   2.493 0.012654 *  
b251         -21.18146    4.11707  -5.145 2.69e-07 ***
b252          12.17220    5.04861   2.411 0.015912 *  
b253         -20.30839    4.11948  -4.930 8.25e-07 ***
b254          12.83830    5.04852   2.543 0.010994 *  
b255         -20.90149    4.11693  -5.077 3.85e-07 ***
b256          11.65546    5.04042   2.312 0.020759 *  
b257         -20.84280    4.11296  -5.068 4.04e-07 ***
b258          13.12249    5.04054   2.603 0.009233 ** 
b259         -20.69938    4.11706  -5.028 4.98e-07 ***
b260          13.31353    5.04860   2.637 0.008365 ** 
b261         -22.25730    4.11946  -5.403 6.58e-08 ***
b262          15.23905    5.04851   3.019 0.002541 ** 
b263         -23.09080    4.11691  -5.609 2.05e-08 ***
b264          15.68398    5.04041   3.112 0.001861 ** 
b265         -22.06500    4.11294  -5.365 8.14e-08 ***
b266          12.76832    5.04053   2.533 0.011307 *  
b267         -19.60325    4.11705  -4.761 1.93e-06 ***
b268          14.29535    5.04859   2.832 0.004634 ** 
b269         -20.97813    4.11945  -5.092 3.55e-07 ***
b270          12.62578    5.04849   2.501 0.012390 *  
b271         -18.87723    4.11690  -4.585 4.54e-06 ***
b272          12.58762    5.04039   2.497 0.012515 *  
b273         -18.04143    4.11293  -4.387 1.15e-05 ***
b274           9.49223    5.04052   1.883 0.059680 .  
b275         -19.59801    4.11704  -4.760 1.94e-06 ***
b276          13.25736    5.04857   2.626 0.008643 ** 
b277         -22.69247    4.11944  -5.509 3.63e-08 ***
b278          13.30617    5.04847   2.636 0.008399 ** 
b279         -21.81449    4.11688  -5.299 1.17e-07 ***
b280          12.42548    5.04037   2.465 0.013697 *  
b281         -19.73880    4.11292  -4.799 1.60e-06 ***
b282          10.91727    5.04051   2.166 0.030322 *  
b283         -19.66200    4.11703  -4.776 1.79e-06 ***
b284          11.98300    5.04856   2.374 0.017621 *  
b285         -21.89957    4.11942  -5.316 1.06e-07 ***
b286          13.15153    5.04846   2.605 0.009188 ** 
b287         -18.80046    4.11687  -4.567 4.96e-06 ***
b288          12.74592    5.04036   2.529 0.011449 *  
b289         -21.52401    4.11290  -5.233 1.67e-07 ***
b290          13.20736    5.04049   2.620 0.008789 ** 
b291         -19.49296    4.11701  -4.735 2.20e-06 ***
b292          11.74240    5.04855   2.326 0.020027 *  
b293         -18.75473    4.11941  -4.553 5.30e-06 ***
b294          10.80969    5.04844   2.141 0.032262 *  
b295         -16.62308    4.11685  -4.038 5.40e-05 ***
b296          11.93331    5.04034   2.368 0.017909 *  
b297         -19.03747    4.11289  -4.629 3.69e-06 ***
b298          13.04631    5.04048   2.588 0.009647 ** 
b299         -19.74157    4.11700  -4.795 1.63e-06 ***
b300          11.88288    5.04853   2.354 0.018589 *  
b301         -18.93375    4.11940  -4.596 4.31e-06 ***
b302          12.22040    5.04842   2.421 0.015496 *  
b303         -17.16353    4.11683  -4.169 3.06e-05 ***
b304          13.22648    5.04032   2.624 0.008689 ** 
b305         -20.11905    4.11287  -4.892 1.00e-06 ***
b306          10.75274    5.04047   2.133 0.032906 *  
b307         -19.37352    4.11699  -4.706 2.54e-06 ***
b308          12.04188    5.04852   2.385 0.017072 *  
b309         -22.17761    4.11938  -5.384 7.32e-08 ***
b310          14.50936    5.04840   2.874 0.004054 ** 
b311         -19.23934    4.11681  -4.673 2.97e-06 ***
b312          12.94885    5.04030   2.569 0.010200 *  
b313         -22.23546    4.11286  -5.406 6.46e-08 ***
b314          13.59907    5.04045   2.698 0.006978 ** 
b315         -20.29330    4.11698  -4.929 8.28e-07 ***
b316          11.80409    5.04850   2.338 0.019383 *  
b317         -15.92509    4.11936  -3.866 0.000111 ***
b318          13.20470    5.04836   2.616 0.008908 ** 
b319         -17.45154    4.11675  -4.239 2.25e-05 ***
b320          13.53358    5.04017   2.685 0.007252 ** 
b321         -17.80753    4.11261  -4.330 1.49e-05 ***
b322          11.63301    5.03985   2.308 0.020991 *  
b323         -19.34032    4.11573  -4.699 2.62e-06 ***
b324          15.06552    5.04542   2.986 0.002828 ** 
b325         -18.13390    4.11340  -4.408 1.04e-05 ***
b326          14.02023    5.03494   2.785 0.005361 ** 
b327         -22.32620    4.10758  -5.435 5.49e-08 ***
b328          15.14833    5.24707   2.887 0.003891 ** 
b329         628.44985 2463.27809   0.255 0.798626    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 4.144 on 59309 degrees of freedom
  (7401 observations deleted due to missingness)
Multiple R-squared:  0.8409,	Adjusted R-squared:   0.84 
F-statistic: 919.4 on 341 and 59309 DF,  p-value: < 2.2e-16

> 
> # register the results
> data <- data %>% mutate(mu = NA , ctemp = NA)
> for(k in 1:p){
+   data[non_na & row_ids[,k],] <- data[non_na & row_ids[,k],] %>% 
+     mutate(mu = lms[[k]]$fitted.values, ctemp = mean_temp - mu)
+ }
> 
> # remove b cols of data (for memory)
> data <- data %>% 
+   select(!any_of(b_cols[[which.max(sapply(b_cols, length))]])) %>%
+   select(!any_of(c(s_cols, c_cols)))
> gc()
            used   (Mb) gc trigger   (Mb)  max used   (Mb)
Ncells   2494410  133.3    4520295  241.5   4520295  241.5
Vcells 186307604 1421.5  615583044 4696.6 512879392 3913.0
> 
> # quick check
> data0 <- data %>% group_by(year, station_name) %>%
+   summarise(m_mt = mean(mean_temp, na.rm=T),
+             m_mu = mean(mu, na.rm=T))
`summarise()` has grouped output by 'year'. You can override using the
`.groups` argument.
> ggplot(data0, aes(x=year, y=m_mt, col=station_name, group=station_name)) +
+   theme_light() +
+   geom_line(data = data0, aes(y=m_mu), col=1) +
+   geom_point()
Warning messages:
1: Removed 20 row(s) containing missing values (geom_path). 
2: Removed 25 rows containing missing values (geom_point). 
> 
> data0 <- data %>% filter(year %in% 1950:1970) %>%
+   group_by(year, month, station_name) %>%
+   summarise(m_mt = mean(mean_temp, na.rm=T),
+             m_mu = mean(mu, na.rm=T))
`summarise()` has grouped output by 'year', 'month'. You can override using the
`.groups` argument.
> ggplot(data0, aes(x=year+month/12, y=m_mt, col=station_name, group=station_name)) +
+   geom_line() + geom_point() +
+   geom_line(data = data0, aes(y=m_mu)) +
+   facet_wrap(~station_name)
Warning messages:
1: Removed 21 row(s) containing missing values (geom_path). 
2: Removed 21 rows containing missing values (geom_point). 
3: Removed 21 row(s) containing missing values (geom_path). 
> 
> 
> # random check of the fits
> # some plots might show a break (when the data goes from Ottawa to Toronto)
> k <- sample(nrow(data),1)
> ii <- k + 1:365
> plot(data$time[ii], data$mean_temp[ii])
> lines(data$time[ii], data$mu[ii], col=2)
> 
> 
> # note that this breaks the equalities in the data
> # but there is still some heterogeneity in the variance
> N <- 20000 
> par(mfrow=c(p,2), mar=c(1,1,0,0))
> for(k in 1:p){
+   plot(data$yday[row_ids[,k]][1:N], data$mean_temp[row_ids[,k]][1:N], cex=.25)
+   plot(data$yday[row_ids[,k]][1:N], data$ctemp[row_ids[,k]][1:N], cex=.25)
+ }
> 
> 
> 
> # Compute pseudo-observations using ECDF ----------------------------------
> data <- data %>% mutate(pseudo_temp = NA, diff = NA, w1 = NA, w = NA)
> for(k in 1:p){
+   id <- stns_id[k]
+   cat("Working on ECDF for station ", id, ".\n")
+   row_id <- row_ids[,k]
+   
+   for(tt in 1:366){
+     if(tt %% 20 == 0) cat("progess: ", round(tt/366*100,2), "%\n")
+     
+     # construct weights based on yday using gaussian kernel
+     data[row_id,] <- data[row_id,] %>%
+       mutate(diff = tt - (time %% year_len)) %>%
+       mutate(diff = abs(pmin(diff, year_len - diff))) %>%
+       mutate(w1 = dnorm(diff,0,2)) %>%
+       mutate(w = w1/sum(w1, na.rm = T)) 
+     
+     # construct ecdf function using all the data
+     wecdf <- spatstat.geom::ewcdf(data[row_id,]$ctemp, data[row_id,]$w)
+     
+     # compute ecdf only for yday we care for
+     ind <- which(data[row_id,]$yday == tt & !is.na(data[row_id,]$ctemp))
+     data[row_id,][ind,] <- data[row_id,][ind,] %>%
+       mutate(pseudo_temp = wecdf(ctemp))
+     
+     # heuristic correction for the largest (pseudo_obs = 1)
+     # to avoid modifying all values (say, with pseudo_obs = pseudo_obs*n_ind/(n_ind+1))
+     n_ind <- length(ind)
+     data[row_id,][ind,] <- data[row_id,][ind,] %>%
+       mutate(pseudo_temp = ifelse(pseudo_temp == 1, 1-1/(2*n_ind), pseudo_temp))
+   }
+ }
Working on ECDF for station  568 .
progess:  5.46 %
progess:  10.93 %
progess:  16.39 %
progess:  21.86 %
progess:  27.32 %
progess:  32.79 %
progess:  38.25 %
progess:  43.72 %
progess:  49.18 %
progess:  54.64 %
progess:  60.11 %
progess:  65.57 %
progess:  71.04 %
progess:  76.5 %
progess:  81.97 %
progess:  87.43 %
progess:  92.9 %
progess:  98.36 %
Working on ECDF for station  4333 .
progess:  5.46 %
progess:  10.93 %
progess:  16.39 %
progess:  21.86 %
progess:  27.32 %
progess:  32.79 %
progess:  38.25 %
progess:  43.72 %
progess:  49.18 %
progess:  54.64 %
progess:  60.11 %
progess:  65.57 %
progess:  71.04 %
progess:  76.5 %
progess:  81.97 %
progess:  87.43 %
progess:  92.9 %
progess:  98.36 %
Working on ECDF for station  5051 .
progess:  5.46 %
progess:  10.93 %
progess:  16.39 %
progess:  21.86 %
progess:  27.32 %
progess:  32.79 %
progess:  38.25 %
progess:  43.72 %
progess:  49.18 %
progess:  54.64 %
progess:  60.11 %
progess:  65.57 %
progess:  71.04 %
progess:  76.5 %
progess:  81.97 %
progess:  87.43 %
progess:  92.9 %
progess:  98.36 %
> 
> 
> 
> # resulting histograms are even better than expected
> ggplot(data, aes(x = pseudo_temp, fill=as.factor(yday))) +
+   theme(legend.position = "none") +
+   geom_histogram(breaks=seq(0,1,.05), position = position_stack()) +
+   facet_wrap(~station_name)
Warning message:
Removed 12480 rows containing non-finite values (stat_bin). 
> 
> # quick check of the other operations (tt = 366, last it. of for loop)
> s <- sample(nrow(data) - 1000,1)
> par(mfrow=c(3,1))
> plot(data$pseudo_temp[s + 1:100], type="o") # makes sense
> plot(data$date[s + 1:1000], data$diff[s + 1:1000]) # linear in time, as expected
> plot(data$date[s + 1:1000], data$w[s + 1:1000], type="l") # select only end of year periods
> 
> # note that there are equalities, but very very few of them. can disregard.
> apply(row_ids, 2, \(r){
+   tab <- table(data[r,]$pseudo_temp)
+   tab[tab > 1]
+ })
[[1]]

0.201298995898649 0.995867768595041 0.995901639344262 0.995967741935484 
                2                 3                 2                 2 
            0.996 
                3 

[[2]]

0.411916657781441 0.428931978379758 0.887698294022364 0.996240601503759 
                2                 2                 2                 6 
0.996268656716418 
                2 

[[3]]

0.369960813688005 0.488381395444058 0.996932515337423 0.996951219512195 
                2                 2                 8                 4 

> 
> 
> 
> # Save for later use ------------------------------------------------------
> saveRDS(data, "app/data/data_pp3.rds")
> 
> proc.time()
    user   system  elapsed 
1449.149   10.290 1459.619 
