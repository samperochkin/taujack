
R version 4.2.1 (2022-06-23) -- "Funny-Looking Kid"
Copyright (C) 2022 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # Preprocessing of the raw data
> # launched with 
> # R CMD BATCH --vanilla --no-restore app/preprocessing.R app/log_pp.txt
> 
> # packages ----------------------------------------------------------------
> library(tidyverse)
── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
✔ ggplot2 3.3.6     ✔ purrr   0.3.4
✔ tibble  3.1.8     ✔ dplyr   1.1.0
✔ tidyr   1.2.1     ✔ stringr 1.4.1
✔ readr   2.1.2     ✔ forcats 0.5.2
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
> library(lubridate)

Attaching package: ‘lubridate’

The following objects are masked from ‘package:base’:

    date, intersect, setdiff, union

> library(lunar)
> library(ggplot2)
> library(spatstat.geom) # weighted ecdf
Loading required package: spatstat.data
spatstat.geom 3.2-4
> 
> 
> 
> # load and preprocess data ------------------------------------------------
> stns_id <- readRDS("app/data/stns_id.rds")
> weathercan::stations() %>% filter(station_id %in% stns_id, interval == "day") %>%
+   print(nrow = nrow(.))
The stations data frame hasn't been updated in over 4 weeks. Consider running `stations_dl()` to check for updates and make sure you have the most recent stations list available
# A tibble: 8 × 16
  prov  station…¹ stati…² clima…³ WMO_id TC_id   lat    lon   elev tz    inter…⁴
  <chr> <chr>       <dbl> <chr>    <dbl> <chr> <dbl>  <dbl>  <dbl> <chr> <chr>  
1 BC    QUATSINO      271 1036570     NA <NA>   50.5 -128.  3.42e0 Etc/… day    
2 BC    BARKERVI…     568 1090660     NA <NA>   53.1 -122.  1.28e3 Etc/… day    
3 BC    AGASSIZ …     707 1100120     NA <NA>   49.2 -122.  1.5 e1 Etc/… day    
4 ON    OTTAWA C…    4333 6105976     NA WCG    45.4  -75.7 7.92e1 Etc/… day    
5 ON    WELLAND      4712 6139445     NA <NA>   43.0  -79.3 1.75e2 Etc/… day    
6 ON    BELLEVIL…    4859 6150689     NA <NA>   44.2  -77.4 7.62e1 Etc/… day    
7 ON    BLOOMFIE…    4862 6150815     NA <NA>   44.0  -77.2 9.14e1 Etc/… day    
8 ON    TORONTO      5051 6158350  71266 <NA>   43.7  -79.4 1.12e2 Etc/… day    
# … with 5 more variables: start <dbl>, end <dbl>, normals <lgl>,
#   normals_1981_2010 <lgl>, normals_1971_2000 <lgl>, and abbreviated variable
#   names ¹​station_name, ²​station_id, ³​climate_id, ⁴​interval
> 
> filepaths <- paste0("app/data/daily_data_", stns_id, ".rds")
> data <- lapply(filepaths, readRDS) |> dplyr::bind_rows()
> str(data)
tibble [421,408 × 37] (S3: tbl_df/tbl/data.frame)
 $ station_name      : chr [1:421408] "QUATSINO" "QUATSINO" "QUATSINO" "QUATSINO" ...
 $ station_id        : num [1:421408] 271 271 271 271 271 271 271 271 271 271 ...
 $ station_operator  : logi [1:421408] NA NA NA NA NA NA ...
 $ prov              : chr [1:421408] "BC" "BC" "BC" "BC" ...
 $ lat               : num [1:421408] 50.5 50.5 50.5 50.5 50.5 ...
 $ lon               : num [1:421408] -128 -128 -128 -128 -128 ...
 $ elev              : num [1:421408] 3.4 3.4 3.4 3.4 3.4 3.4 3.4 3.4 3.4 3.4 ...
 $ climate_id        : chr [1:421408] "1036570" "1036570" "1036570" "1036570" ...
 $ WMO_id            : chr [1:421408] NA NA NA NA ...
 $ TC_id             : chr [1:421408] NA NA NA NA ...
 $ date              : Date[1:421408], format: "1895-01-01" "1895-01-02" ...
 $ year              : chr [1:421408] "1895" "1895" "1895" "1895" ...
 $ month             : chr [1:421408] "01" "01" "01" "01" ...
 $ day               : chr [1:421408] "01" "02" "03" "04" ...
 $ qual              : chr [1:421408] NA NA NA NA ...
 $ cool_deg_days     : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ cool_deg_days_flag: chr [1:421408] NA NA NA NA ...
 $ dir_max_gust      : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ dir_max_gust_flag : chr [1:421408] NA NA NA NA ...
 $ heat_deg_days     : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ heat_deg_days_flag: chr [1:421408] NA NA NA NA ...
 $ max_temp          : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ max_temp_flag     : chr [1:421408] NA NA NA NA ...
 $ mean_temp         : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ mean_temp_flag    : chr [1:421408] NA NA NA NA ...
 $ min_temp          : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ min_temp_flag     : chr [1:421408] NA NA NA NA ...
 $ snow_grnd         : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ snow_grnd_flag    : chr [1:421408] NA NA NA NA ...
 $ spd_max_gust      : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ spd_max_gust_flag : chr [1:421408] NA NA NA NA ...
 $ total_precip      : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ total_precip_flag : chr [1:421408] NA NA NA NA ...
 $ total_rain        : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ total_rain_flag   : chr [1:421408] NA NA NA NA ...
 $ total_snow        : num [1:421408] NA NA NA NA NA NA NA NA NA NA ...
 $ total_snow_flag   : chr [1:421408] NA NA NA NA ...
> 
> # time variables setup
> data <- data %>% mutate(date = as.Date(date),
+                         year = as.integer(year),
+                         month = as.integer(month),
+                         day = as.integer(day))
> 
> data <- data %>% mutate(time = as.integer(date),
+                         yday = lubridate::yday(date),
+                         week = lubridate::week(date))
> 
> # stations we look at
> stns_id <- c(568, 4333, 5051)
> p <- 3
> data <- data %>%
+   filter(station_id %in% stns_id) %>%
+   arrange(station_id, date)
> 
> # quick look at summary of the data (clearly shows time trends)
> data0 <- data %>% group_by(station_name, year) %>%
+   summarise(mm_temp = mean(mean_temp, na.rm=T))
`summarise()` has grouped output by 'station_name'. You can override using the
`.groups` argument.
> ggplot(data0, aes(x=year, y=mm_temp)) +
+   geom_line() +
+   geom_point() +
+   facet_wrap(~station_name)
Warning messages:
1: Removed 20 row(s) containing missing values (geom_path). 
2: Removed 25 rows containing missing values (geom_point). 
> 
> 
> # Estimate mean conditional on time of year -------------------------------
> year_len <- 365 + 6/24 + 9/60/24 + 9/60^2/24
> 
> # create sines-cosines basis (for seasonal trend)
> # nSC <- 24
> # s_cols <- paste0("s", 1:nSC)
> # c_cols <- paste0("c", 1:nSC)
> # for (i in 1:nSC) data <- data %>%
> #   mutate(!!s_cols[i] := sin(i*2*pi*time/year_len),
> #          !!c_cols[i] := cos(i*2*pi*time/year_len))
> ffreq <- 1:2
> nSC <- length(ffreq)
> s_cols <- paste0("s", ffreq)
> c_cols <- paste0("c", ffreq)
> for (i in 1:nSC) data <- data %>%
+   mutate(!!s_cols[i] := sin(i*2*pi*time/year_len),
+          !!c_cols[i] := cos(i*2*pi*time/year_len))
> 
> 
> # create natural spline basis (for long term time trend)
> # for this check range for each station
> row_ids <- sapply(stns_id, \(id) data$station_id == id)
> bss <- lapply(1:p, \(k){
+   data[row_ids[,k],] %>% filter(day == 21, month %in% c(6,12)) %>% select(time) %>% unlist
+ })
> 
> for(b in paste("b", 1:max(sapply(bss, length)))) data <- data %>% mutate(!!b := NA)
> nB <- rep(0, p); b_cols <- list()
> for(k in 1:p){
+   B <- splines::bs(data[row_ids[,k],]$time, knots = c(bss[[k]]), degree = 2)
+   B <- B[,colSums(abs(B[!is.na(data[row_ids[,k],]$mean_temp),])) > 1e-5]
+   nB[k] <- ncol(B)
+   b_cols[[length(b_cols)+1]] <- paste0("b", 1:nB[k])
+   data[row_ids[,k],b_cols[[k]]] <- B
+   rm(B)
+ }
> 
> 
> # fit least-squares
> non_na <- !is.na(data$mean_temp) # for later
> lms <- lapply(1:p, \(k){
+   if(k == 1){
+     l <- length(b_cols[[k]])
+     x_cols <- c("mean_temp", s_cols, c_cols, b_cols[[k]][seq(2,l,2)])
+   }else{
+     x_cols <- c("mean_temp", s_cols, c_cols, b_cols[[k]])
+   }
+   lm(formula = "mean_temp~.", data = data[row_ids[,k],x_cols])
+ })
> 
> # Bakerville
> summary(lms[[1]])

Call:
lm(formula = "mean_temp~.", data = data[row_ids[, k], x_cols])

Residuals:
    Min      1Q  Median      3Q     Max 
-31.968  -2.466   0.268   3.056  16.800 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)    5.91856    1.09814   5.390 7.10e-08 ***
s1            -5.14356    0.55897  -9.202  < 2e-16 ***
s2             0.58451    0.03215  18.179  < 2e-16 ***
c1           -10.60769    0.11271 -94.118  < 2e-16 ***
c2            -0.31701    0.03200  -9.908  < 2e-16 ***
b2            -5.21944    2.29564  -2.274 0.022993 *  
b4            -6.54343    2.25252  -2.905 0.003675 ** 
b6            -6.91678    2.25068  -3.073 0.002119 ** 
b8            -6.87182    2.25006  -3.054 0.002259 ** 
b10           -7.33854    2.24720  -3.266 0.001093 ** 
b12           -8.42233    2.25893  -3.728 0.000193 ***
b14           -6.82593    2.25053  -3.033 0.002422 ** 
b16           -7.30967    2.24852  -3.251 0.001151 ** 
b18           -7.98830    2.24873  -3.552 0.000382 ***
b20           -6.12011    2.25054  -2.719 0.006543 ** 
b22           -6.87358    2.25513  -3.048 0.002305 ** 
b24           -6.70725    2.25055  -2.980 0.002882 ** 
b26           -7.44635    2.25059  -3.309 0.000938 ***
b28           -5.94996    2.25060  -2.644 0.008203 ** 
b30           -8.62923    2.25063  -3.834 0.000126 ***
b32           -8.90451    2.24856  -3.960 7.50e-05 ***
b34           -6.05980    2.24855  -2.695 0.007042 ** 
b36           -7.39911    2.25063  -3.288 0.001011 ** 
b38           -8.49323    2.25176  -3.772 0.000162 ***
b40           -6.99125    2.24968  -3.108 0.001887 ** 
b42           -7.90083    2.24855  -3.514 0.000442 ***
b44          -11.00646    2.25063  -4.890 1.01e-06 ***
b46          -10.10746    2.25063  -4.491 7.11e-06 ***
b48          -10.04970    2.24856  -4.469 7.86e-06 ***
b50           -9.22838    2.24855  -4.104 4.07e-05 ***
b52           -8.64902    2.25063  -3.843 0.000122 ***
b54           -7.88332    2.25063  -3.503 0.000461 ***
b56           -9.32685    2.24856  -4.148 3.36e-05 ***
b58          -10.47391    2.24855  -4.658 3.20e-06 ***
b60           -8.71986    2.25063  -3.874 0.000107 ***
b62           -7.36861    2.25063  -3.274 0.001061 ** 
b64          -10.65589    2.24856  -4.739 2.15e-06 ***
b66           -8.91107    2.24855  -3.963 7.41e-05 ***
b68          -10.48087    2.25063  -4.657 3.22e-06 ***
b70           -8.37049    2.25063  -3.719 0.000200 ***
b72           -6.12591    2.24856  -2.724 0.006445 ** 
b74           -8.78923    2.24855  -3.909 9.29e-05 ***
b76           -6.61237    2.25063  -2.938 0.003305 ** 
b78           -8.29680    2.25063  -3.686 0.000228 ***
b80           -9.52966    2.24856  -4.238 2.26e-05 ***
b82           -7.87189    2.24855  -3.501 0.000464 ***
b84           -9.13160    2.25057  -4.057 4.97e-05 ***
b86           -6.50491    2.25063  -2.890 0.003851 ** 
b88           -8.67083    2.24856  -3.856 0.000115 ***
b90           -7.62263    2.24856  -3.390 0.000700 ***
b92          -10.08475    2.25063  -4.481 7.45e-06 ***
b94          -10.23646    2.25063  -4.548 5.42e-06 ***
b96           -9.58233    2.24857  -4.262 2.03e-05 ***
b98          -10.05499    2.25095  -4.467 7.95e-06 ***
b100          -6.58759    2.25065  -2.927 0.003424 ** 
b102          -7.07905    2.25063  -3.145 0.001660 ** 
b104          -6.83904    2.24856  -3.042 0.002355 ** 
b106          -7.66093    2.24856  -3.407 0.000657 ***
b108          -8.25602    2.25063  -3.668 0.000244 ***
b110          -9.72028    2.25063  -4.319 1.57e-05 ***
b112          -8.36772    2.24856  -3.721 0.000198 ***
b114          -6.99707    2.24856  -3.112 0.001861 ** 
b116         -10.54636    2.25063  -4.686 2.79e-06 ***
b118         -10.12093    2.25063  -4.497 6.91e-06 ***
b120          -8.01564    2.24856  -3.565 0.000365 ***
b122          -9.01635    2.25150  -4.005 6.22e-05 ***
b124        -345.29870   65.31194  -5.287 1.25e-07 ***
b126         -13.01432    2.32863  -5.589 2.30e-08 ***
b128          -6.79020    2.24897  -3.019 0.002535 ** 
b130          -7.76993    2.25063  -3.452 0.000556 ***
b132          -8.71011    2.25063  -3.870 0.000109 ***
b134         -12.75778    2.24855  -5.674 1.41e-08 ***
b136         -10.15726    2.24856  -4.517 6.28e-06 ***
b138          -7.83819    2.25063  -3.483 0.000497 ***
b140          -7.27174    2.25063  -3.231 0.001235 ** 
b142         -10.25375    2.24855  -4.560 5.13e-06 ***
b144          -7.82430    2.24856  -3.480 0.000502 ***
b146          -9.11610    2.25063  -4.050 5.12e-05 ***
b148          -7.25115    2.25063  -3.222 0.001275 ** 
b150          -7.56396    2.24855  -3.364 0.000769 ***
b152         -11.40946    2.24917  -5.073 3.94e-07 ***
b154          -8.97680    2.25096  -3.988 6.67e-05 ***
b156          -8.67368    2.25066  -3.854 0.000116 ***
b158          -7.34842    2.24855  -3.268 0.001084 ** 
b160         -11.61802    2.24856  -5.167 2.39e-07 ***
b162          -6.98237    2.25063  -3.102 0.001921 ** 
b164          -9.78567    2.25062  -4.348 1.38e-05 ***
b166         -10.34234    2.24855  -4.600 4.25e-06 ***
b168         -10.41301    2.24856  -4.631 3.65e-06 ***
b170         -10.35302    2.25063  -4.600 4.24e-06 ***
b172          -8.73032    2.25062  -3.879 0.000105 ***
b174          -8.34316    2.24855  -3.710 0.000207 ***
b176          -6.30158    2.24894  -2.802 0.005080 ** 
b178         -10.09480    2.25082  -4.485 7.31e-06 ***
b180          -4.73582    2.31911  -2.042 0.041149 *  
b182          -6.46336    2.25006  -2.873 0.004074 ** 
b184          -6.69081    2.24855  -2.976 0.002926 ** 
b186          -7.55443    2.25062  -3.357 0.000790 ***
b188          -7.58459    2.25282  -3.367 0.000761 ***
b190          -8.20485    2.25245  -3.643 0.000270 ***
b192         -10.52474    2.24858  -4.681 2.87e-06 ***
b194         -10.51786    2.25862  -4.657 3.22e-06 ***
b196          -7.23324    2.25066  -3.214 0.001311 ** 
b198          -6.57187    2.24856  -2.923 0.003472 ** 
b200          -8.12967    2.24965  -3.614 0.000302 ***
b202          -6.99650    2.25064  -3.109 0.001881 ** 
b204          -8.73072    2.25086  -3.879 0.000105 ***
b206          -6.45359    2.24883  -2.870 0.004110 ** 
b208          -8.66376    2.24856  -3.853 0.000117 ***
b210          -6.97061    2.25063  -3.097 0.001955 ** 
b212          -7.46148    2.25061  -3.315 0.000916 ***
b214          -8.77960    2.25080  -3.901 9.61e-05 ***
b216         -10.91635    2.25090  -4.850 1.24e-06 ***
b218          -7.36963    2.25065  -3.274 0.001060 ** 
b220          -6.20264    2.25063  -2.756 0.005854 ** 
b222          -8.01429    2.24896  -3.564 0.000366 ***
b224          -8.66676    2.24856  -3.854 0.000116 ***
b226          -8.48621    2.25062  -3.771 0.000163 ***
b228          -7.48026    2.25146  -3.322 0.000893 ***
b230          -8.19877    2.24854  -3.646 0.000266 ***
b232          -7.43051    2.25495  -3.295 0.000984 ***
b234          -7.67717    2.25061  -3.411 0.000647 ***
b236          -7.35766    2.25061  -3.269 0.001079 ** 
b238          -8.45113    2.27114  -3.721 0.000199 ***
b240          -9.61441    2.26589  -4.243 2.21e-05 ***
b242          -5.33634    2.31903  -2.301 0.021390 *  
b244          -9.06538    2.32088  -3.906 9.40e-05 ***
b246          -9.33537    2.26519  -4.121 3.78e-05 ***
b248          -6.95541    2.25103  -3.090 0.002004 ** 
b250          -6.99786    2.26144  -3.094 0.001973 ** 
b252          -5.79300    2.27122  -2.551 0.010757 *  
b254          39.30696    7.72429   5.089 3.62e-07 ***
b256          -7.52656    2.32160  -3.242 0.001188 ** 
b258          -7.59897    2.25377  -3.372 0.000748 ***
b260          -7.50268    2.25266  -3.331 0.000867 ***
b262          -1.99466    1.60874  -1.240 0.215022    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 4.796 on 44783 degrees of freedom
  (4601 observations deleted due to missingness)
Multiple R-squared:  0.7151,	Adjusted R-squared:  0.7142 
F-statistic: 832.6 on 135 and 44783 DF,  p-value: < 2.2e-16

> # Ottawa
> summary(lms[[2]])

Call:
lm(formula = "mean_temp~.", data = data[row_ids[, k], x_cols])

Residuals:
     Min       1Q   Median       3Q      Max 
-21.9392  -2.9989  -0.0189   3.0483  18.7644 

Coefficients: (1 not defined because of singularities)
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)   27.89911    8.05303   3.464 0.000532 ***
s1             0.76341    0.76872   0.993 0.320670    
s2            -1.03879    0.03037 -34.201  < 2e-16 ***
c1           -13.75119    0.15236 -90.257  < 2e-16 ***
c2            -0.77488    0.03038 -25.507  < 2e-16 ***
b1          -102.51012   55.78552  -1.838 0.066131 .  
b2            -5.49966    8.28950  -0.663 0.507046    
b3           -35.76506    8.28409  -4.317 1.58e-05 ***
b4           -10.75729    8.15533  -1.319 0.187158    
b5           -35.72793    8.27541  -4.317 1.58e-05 ***
b6            -8.38035    8.15398  -1.028 0.304067    
b7           -35.01676    8.27520  -4.232 2.33e-05 ***
b8           -10.18319    8.15419  -1.249 0.211733    
b9           -37.26539    8.27592  -4.503 6.72e-06 ***
b10           -9.74782    8.15493  -1.195 0.231965    
b11          -34.18730    8.27633  -4.131 3.62e-05 ***
b12           -9.84024    8.15496  -1.207 0.227570    
b13          -34.62003    8.27599  -4.183 2.88e-05 ***
b14          -10.44779    8.15428  -1.281 0.200107    
b15          -34.82650    8.27540  -4.208 2.58e-05 ***
b16          -10.03720    8.15429  -1.231 0.218362    
b17          -33.90218    8.27605  -4.096 4.20e-05 ***
b18          -10.74429    8.15514  -1.317 0.187681    
b19          -32.50997    8.27692  -3.928 8.59e-05 ***
b20           -9.00683    8.15647  -1.104 0.269488    
b21          -35.90282    8.28148  -4.335 1.46e-05 ***
b22           -8.40651    8.15510  -1.031 0.302626    
b23          -35.22504    8.27649  -4.256 2.08e-05 ***
b24           -8.41455    8.15515  -1.032 0.302167    
b25          -34.66119    8.27656  -4.188 2.82e-05 ***
b26           -9.54207    8.15517  -1.170 0.241981    
b27          -32.99253    8.27650  -3.986 6.72e-05 ***
b28          -12.02606    8.15505  -1.475 0.140306    
b29          -31.16432    8.27606  -3.766 0.000166 ***
b30          -12.71332    8.15434  -1.559 0.118983    
b31          -36.09776    8.27545  -4.362 1.29e-05 ***
b32          -11.31933    8.15433  -1.388 0.165102    
b33          -37.37697    8.27604  -4.516 6.31e-06 ***
b34           -9.03932    8.15502  -1.108 0.267679    
b35          -34.47408    8.27641  -4.165 3.11e-05 ***
b36           -9.03712    8.15503  -1.108 0.267796    
b37          -37.96574    8.27604  -4.587 4.50e-06 ***
b38          -10.00822    8.15434  -1.227 0.219697    
b39          -36.20464    8.27545  -4.375 1.22e-05 ***
b40           -7.68629    8.15433  -0.943 0.345890    
b41          -35.93713    8.27604  -4.342 1.41e-05 ***
b42          -10.04646    8.15502  -1.232 0.217979    
b43          -31.32763    8.27641  -3.785 0.000154 ***
b44          -11.82738    8.15503  -1.450 0.146977    
b45          -34.78900    8.27604  -4.204 2.63e-05 ***
b46           -8.08288    8.15434  -0.991 0.321575    
b47          -37.88806    8.27545  -4.578 4.70e-06 ***
b48           -8.53058    8.15433  -1.046 0.295501    
b49          -33.91365    8.27604  -4.098 4.18e-05 ***
b50           -8.66574    8.15502  -1.063 0.287957    
b51          -35.10834    8.27641  -4.242 2.22e-05 ***
b52           -9.88530    8.15503  -1.212 0.225452    
b53          -33.46098    8.27604  -4.043 5.28e-05 ***
b54           -8.91313    8.15434  -1.093 0.274376    
b55          -36.06200    8.27545  -4.358 1.32e-05 ***
b56           -8.56620    8.15433  -1.051 0.293489    
b57          -37.04978    8.27604  -4.477 7.60e-06 ***
b58          -11.18875    8.15503  -1.372 0.170068    
b59          -36.72170    8.27641  -4.437 9.15e-06 ***
b60           -9.38836    8.15503  -1.151 0.249641    
b61          -32.61090    8.27604  -3.940 8.15e-05 ***
b62          -10.68697    8.15434  -1.311 0.190004    
b63          -35.95289    8.27545  -4.345 1.40e-05 ***
b64           -8.88570    8.15434  -1.090 0.275855    
b65          -30.84248    8.27604  -3.727 0.000194 ***
b66           -9.75324    8.15503  -1.196 0.231711    
b67          -34.14919    8.27642  -4.126 3.70e-05 ***
b68           -8.43780    8.15506  -1.035 0.300828    
b69          -38.57894    8.27614  -4.661 3.15e-06 ***
b70           -7.59683    8.15434  -0.932 0.351532    
b71          -35.38484    8.27544  -4.276 1.91e-05 ***
b72          -10.86071    8.15433  -1.332 0.182901    
b73          -33.63613    8.27604  -4.064 4.83e-05 ***
b74          -10.78224    8.15503  -1.322 0.186121    
b75          -37.01880    8.27641  -4.473 7.74e-06 ***
b76          -11.27718    8.15503  -1.383 0.166718    
b77          -34.48002    8.27604  -4.166 3.10e-05 ***
b78           -9.70944    8.15434  -1.191 0.233774    
b79          -35.27455    8.27545  -4.263 2.02e-05 ***
b80          -10.72477    8.15434  -1.315 0.188441    
b81          -34.59794    8.27604  -4.180 2.91e-05 ***
b82          -11.37808    8.15503  -1.395 0.162955    
b83          -34.52389    8.27641  -4.171 3.03e-05 ***
b84          -10.02719    8.15503  -1.230 0.218864    
b85          -34.03972    8.27604  -4.113 3.91e-05 ***
b86           -7.35386    8.15434  -0.902 0.367150    
b87          -34.68559    8.27545  -4.191 2.78e-05 ***
b88          -10.92255    8.15434  -1.339 0.180422    
b89          -31.22300    8.27604  -3.773 0.000162 ***
b90          -12.82680    8.15503  -1.573 0.115755    
b91          -39.26916    8.27641  -4.745 2.09e-06 ***
b92           -8.55668    8.15503  -1.049 0.294067    
b93          -37.22317    8.27604  -4.498 6.89e-06 ***
b94          -10.06522    8.15434  -1.234 0.217083    
b95          -35.96019    8.27545  -4.345 1.39e-05 ***
b96          -10.92181    8.15434  -1.339 0.180451    
b97          -32.82248    8.27604  -3.966 7.32e-05 ***
b98          -10.50798    8.15503  -1.289 0.197569    
b99          -35.26635    8.27641  -4.261 2.04e-05 ***
b100          -8.58653    8.15503  -1.053 0.292387    
b101         -37.18467    8.27604  -4.493 7.04e-06 ***
b102          -9.84258    8.15434  -1.207 0.227424    
b103         -36.98455    8.27545  -4.469 7.87e-06 ***
b104         -10.72354    8.15434  -1.315 0.188492    
b105         -34.59596    8.27604  -4.180 2.92e-05 ***
b106         -10.33519    8.15503  -1.267 0.205040    
b107         -32.30609    8.27640  -3.903 9.50e-05 ***
b108         -11.00909    8.15503  -1.350 0.177031    
b109         -36.83224    8.27611  -4.450 8.59e-06 ***
b110         -10.29719    8.15435  -1.263 0.206673    
b111         -34.57740    8.27544  -4.178 2.94e-05 ***
b112          -9.69740    8.15433  -1.189 0.234354    
b113         -35.01569    8.27611  -4.231 2.33e-05 ***
b114         -10.21322    8.15564  -1.252 0.210470    
b115         -35.17113    8.27638  -4.250 2.15e-05 ***
b116          -8.77564    8.15502  -1.076 0.281887    
b117         -36.75987    8.27602  -4.442 8.94e-06 ***
b118          -7.76816    8.15434  -0.953 0.340777    
b119         -37.72625    8.27544  -4.559 5.16e-06 ***
b120          -6.54815    8.15434  -0.803 0.421964    
b121         -33.50521    8.27604  -4.048 5.16e-05 ***
b122          -8.55714    8.15503  -1.049 0.294042    
b123         -35.31802    8.27641  -4.267 1.98e-05 ***
b124         -10.54094    8.15504  -1.293 0.196166    
b125         -32.17860    8.27605  -3.888 0.000101 ***
b126         -11.57467    8.15437  -1.419 0.155776    
b127         -32.51872    8.27554  -3.929 8.52e-05 ***
b128         -10.08412    8.15433  -1.237 0.216220    
b129         -31.10064    8.27603  -3.758 0.000172 ***
b130          -9.63073    8.15504  -1.181 0.237627    
b131         -32.95606    8.27656  -3.982 6.85e-05 ***
b132         -11.68376    8.15504  -1.433 0.151949    
b133         -33.13244    8.27603  -4.003 6.25e-05 ***
b134          -8.04577    8.15434  -0.987 0.323802    
b135         -36.45225    8.27544  -4.405 1.06e-05 ***
b136         -10.91073    8.15434  -1.338 0.180894    
b137         -33.07707    8.27604  -3.997 6.43e-05 ***
b138          -9.85772    8.15503  -1.209 0.226749    
b139         -32.12646    8.27640  -3.882 0.000104 ***
b140         -12.34943    8.15503  -1.514 0.129948    
b141         -35.19291    8.27603  -4.252 2.12e-05 ***
b142          -7.97764    8.15434  -0.978 0.327916    
b143         -35.01463    8.27545  -4.231 2.33e-05 ***
b144          -8.60767    8.15434  -1.056 0.291159    
b145         -35.72783    8.27604  -4.317 1.58e-05 ***
b146          -8.08868    8.15503  -0.992 0.321269    
b147         -34.12623    8.27640  -4.123 3.74e-05 ***
b148         -10.54277    8.15503  -1.293 0.196089    
b149         -35.43927    8.27603  -4.282 1.85e-05 ***
b150          -9.66331    8.15434  -1.185 0.236003    
b151         -32.70837    8.27545  -3.952 7.75e-05 ***
b152         -10.98323    8.15434  -1.347 0.178013    
b153         -34.08550    8.27604  -4.119 3.82e-05 ***
b154         -10.50666    8.15503  -1.288 0.197625    
b155         -32.93192    8.27640  -3.979 6.93e-05 ***
b156          -9.84208    8.15503  -1.207 0.227487    
b157         -34.72742    8.27603  -4.196 2.72e-05 ***
b158         -10.31572    8.15434  -1.265 0.205857    
b159         -33.81969    8.27544  -4.087 4.38e-05 ***
b160          -9.24190    8.15434  -1.133 0.257064    
b161         -34.08801    8.27604  -4.119 3.81e-05 ***
b162          -9.66786    8.15503  -1.186 0.235822    
b163         -35.83762    8.27640  -4.330 1.49e-05 ***
b164          -7.95718    8.15503  -0.976 0.329199    
b165         -37.28367    8.27603  -4.505 6.65e-06 ***
b166          -7.49190    8.15434  -0.919 0.358225    
b167         -36.21825    8.27544  -4.377 1.21e-05 ***
b168         -10.70024    8.15434  -1.312 0.189454    
b169         -32.65835    8.27604  -3.946 7.95e-05 ***
b170          -8.68288    8.15503  -1.065 0.287005    
b171         -34.90726    8.27640  -4.218 2.47e-05 ***
b172         -10.58782    8.15503  -1.298 0.194185    
b173         -31.98644    8.27603  -3.865 0.000111 ***
b174         -10.05793    8.15434  -1.233 0.217416    
b175         -32.75112    8.27544  -3.958 7.58e-05 ***
b176         -12.84353    8.15434  -1.575 0.115251    
b177         -32.08300    8.27604  -3.877 0.000106 ***
b178         -10.60170    8.15503  -1.300 0.193601    
b179         -34.77174    8.27640  -4.201 2.66e-05 ***
b180          -9.96786    8.15503  -1.222 0.221602    
b181         -33.44172    8.27603  -4.041 5.34e-05 ***
b182          -9.95559    8.15434  -1.221 0.222132    
b183         -31.43969    8.27544  -3.799 0.000145 ***
b184         -13.35132    8.15434  -1.637 0.101569    
b185         -31.51584    8.27604  -3.808 0.000140 ***
b186         -10.97643    8.15503  -1.346 0.178319    
b187         -34.67134    8.27640  -4.189 2.80e-05 ***
b188          -9.20190    8.15503  -1.128 0.259169    
b189         -32.17390    8.27603  -3.888 0.000101 ***
b190          -9.74892    8.15434  -1.196 0.231878    
b191         -34.55689    8.27544  -4.176 2.97e-05 ***
b192          -9.13864    8.15434  -1.121 0.262418    
b193         -33.39940    8.27604  -4.036 5.45e-05 ***
b194         -10.55438    8.15503  -1.294 0.195597    
b195         -31.47553    8.27640  -3.803 0.000143 ***
b196         -12.46450    8.15503  -1.528 0.126409    
b197         -29.84790    8.27603  -3.607 0.000311 ***
b198         -11.52001    8.15434  -1.413 0.157737    
b199         -31.32946    8.27544  -3.786 0.000153 ***
b200         -10.78090    8.15434  -1.322 0.186140    
b201         -32.38803    8.27604  -3.913 9.11e-05 ***
b202         -11.35763    8.15503  -1.393 0.163713    
b203         -32.00212    8.27640  -3.867 0.000110 ***
b204         -10.62528    8.15503  -1.303 0.192612    
b205         -30.26329    8.27602  -3.657 0.000256 ***
b206          -9.64518    8.15434  -1.183 0.236883    
b207         -34.89816    8.27544  -4.217 2.48e-05 ***
b208         -10.73339    8.15434  -1.316 0.188087    
b209         -33.50833    8.27604  -4.049 5.16e-05 ***
b210         -10.25018    8.15503  -1.257 0.208791    
b211         -36.09682    8.27640  -4.361 1.29e-05 ***
b212          -8.12313    8.15503  -0.996 0.319212    
b213         -31.32239    8.27602  -3.785 0.000154 ***
b214         -10.81488    8.15434  -1.326 0.184756    
b215         -34.67423    8.27544  -4.190 2.79e-05 ***
b216          -8.77395    8.15434  -1.076 0.281940    
b217         -33.53757    8.27603  -4.052 5.08e-05 ***
b218         -11.24577    8.15503  -1.379 0.167902    
b219         -29.10147    8.27640  -3.516 0.000438 ***
b220          -9.60554    8.15503  -1.178 0.238856    
b221         -30.60873    8.27602  -3.698 0.000217 ***
b222          -8.59415    8.15434  -1.054 0.291918    
b223         -31.17957    8.27544  -3.768 0.000165 ***
b224         -11.14710    8.15434  -1.367 0.171627    
b225         -33.36566    8.27603  -4.032 5.55e-05 ***
b226          -6.31050    8.15503  -0.774 0.439043    
b227         -31.46955    8.27639  -3.802 0.000144 ***
b228          -9.56733    8.15503  -1.173 0.240729    
b229         -34.88058    8.27602  -4.215 2.51e-05 ***
b230          -8.37016    8.15434  -1.026 0.304677    
b231         -33.28818    8.27544  -4.023 5.77e-05 ***
b232          -9.51651    8.15434  -1.167 0.243197    
b233         -33.45626    8.27603  -4.043 5.30e-05 ***
b234          -7.30435    8.15503  -0.896 0.370425    
b235         -31.34269    8.27639  -3.787 0.000153 ***
b236          -8.97203    8.15503  -1.100 0.271258    
b237         -32.34723    8.27602  -3.909 9.30e-05 ***
b238          -9.23327    8.15434  -1.132 0.257508    
b239         -32.04059    8.27543  -3.872 0.000108 ***
b240         -11.22491    8.15434  -1.377 0.168656    
b241         -32.33339    8.27603  -3.907 9.36e-05 ***
b242         -11.29951    8.15503  -1.386 0.165879    
b243         -27.36054    8.27639  -3.306 0.000948 ***
b244         -10.82269    8.15503  -1.327 0.184476    
b245         -32.12101    8.27602  -3.881 0.000104 ***
b246          -7.92636    8.15434  -0.972 0.331034    
b247         -29.05381    8.27543  -3.511 0.000447 ***
b248          -9.31221    8.15434  -1.142 0.253462    
b249         -31.82184    8.27603  -3.845 0.000121 ***
b250          -9.82908    8.15503  -1.205 0.228102    
b251         -35.34461    8.27639  -4.271 1.95e-05 ***
b252          -7.88644    8.15503  -0.967 0.333517    
b253         -36.54167    8.27601  -4.415 1.01e-05 ***
b254          -5.44187    8.15434  -0.667 0.504546    
b255         -32.85135    8.27542  -3.970 7.21e-05 ***
b256          -7.57998    8.15434  -0.930 0.352601    
b257         -32.10280    8.27599  -3.879 0.000105 ***
b258          -9.35982    8.15507  -1.148 0.251086    
b259         -31.84675    8.27742  -3.847 0.000120 ***
b260          -9.20486    8.15575  -1.129 0.259058    
b261         -34.40915    8.27580  -4.158 3.22e-05 ***
b262         -10.29106    8.15721  -1.262 0.207102    
b263         -28.87610    8.28441  -3.486 0.000491 ***
b264          -9.35396    8.15702  -1.147 0.251496    
b265         -30.57055    8.27005  -3.697 0.000219 ***
b266          -8.09148    8.16810  -0.991 0.321877    
b267         -32.24773    8.24610  -3.911 9.22e-05 ***
b268          -8.86730    8.23327  -1.077 0.281482    
b269         -28.26886    8.09855  -3.491 0.000482 ***
b270         -20.50966    8.58096  -2.390 0.016846 *  
b271                NA         NA      NA       NA    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 4.731 on 48401 degrees of freedom
  (478 observations deleted due to missingness)
Multiple R-squared:  0.8522,	Adjusted R-squared:  0.8513 
F-statistic:  1018 on 274 and 48401 DF,  p-value: < 2.2e-16

> # Toronto
> summary(lms[[3]])

Call:
lm(formula = "mean_temp~.", data = data[row_ids[, k], x_cols])

Residuals:
     Min       1Q   Median       3Q      Max 
-20.7356  -2.6890   0.0149   2.7928  15.7740 

Coefficients:
              Estimate Std. Error  t value Pr(>|t|)    
(Intercept)   14.09904    2.99794    4.703 2.57e-06 ***
s1            -0.48477    0.58861   -0.824 0.410179    
s2            -0.10929    0.02407   -4.540 5.63e-06 ***
c1           -11.36282    0.11153 -101.881  < 2e-16 ***
c2             0.01338    0.02407    0.556 0.578318    
b1           -15.99463    3.82449   -4.182 2.89e-05 ***
b2             1.08923    3.14491    0.346 0.729084    
b3           -16.39018    3.24467   -5.051 4.40e-07 ***
b4             1.76099    3.31757    0.531 0.595554    
b5           -14.04966    3.16933   -4.433 9.31e-06 ***
b6             0.50301    3.34917    0.150 0.880615    
b7           -17.27108    3.15524   -5.474 4.42e-08 ***
b8             1.02586    3.35353    0.306 0.759678    
b9           -13.84297    3.15213   -4.392 1.13e-05 ***
b10            0.66445    3.35458    0.198 0.842989    
b11          -13.92376    3.15221   -4.417 1.00e-05 ***
b12           -0.23354    3.35633   -0.070 0.944526    
b13          -15.65856    3.15249   -4.967 6.82e-07 ***
b14            3.92367    3.35640    1.169 0.242404    
b15          -18.01997    3.15213   -5.717 1.09e-08 ***
b16            1.47365    3.35488    0.439 0.660477    
b17          -15.06468    3.15155   -4.780 1.76e-06 ***
b18            0.70074    3.35483    0.209 0.834547    
b19          -17.48197    3.15210   -5.546 2.93e-08 ***
b20            2.26831    3.35638    0.676 0.499158    
b21          -15.38248    3.15247   -4.880 1.07e-06 ***
b22            0.44825    3.35642    0.134 0.893759    
b23          -15.16245    3.15212   -4.810 1.51e-06 ***
b24            0.25514    3.35488    0.076 0.939379    
b25          -18.54204    3.15155   -5.883 4.04e-09 ***
b26            2.27973    3.35484    0.680 0.496802    
b27          -16.37976    3.15211   -5.196 2.04e-07 ***
b28            1.85952    3.35639    0.554 0.579564    
b29          -17.71656    3.15247   -5.620 1.92e-08 ***
b30            3.69199    3.35642    1.100 0.271346    
b31          -18.19264    3.15212   -5.772 7.89e-09 ***
b32            2.60676    3.35489    0.777 0.437160    
b33          -20.18165    3.15155   -6.404 1.53e-10 ***
b34            2.86590    3.35484    0.854 0.392965    
b35          -20.03902    3.15211   -6.357 2.07e-10 ***
b36            2.54656    3.35639    0.759 0.448024    
b37          -16.33673    3.15247   -5.182 2.20e-07 ***
b38            2.04119    3.35643    0.608 0.543094    
b39          -14.17743    3.15213   -4.498 6.88e-06 ***
b40           -0.22162    3.35489   -0.066 0.947331    
b41          -15.10777    3.15156   -4.794 1.64e-06 ***
b42            1.49430    3.35485    0.445 0.656022    
b43          -17.42636    3.15211   -5.528 3.24e-08 ***
b44            2.82080    3.35640    0.840 0.400673    
b45          -16.95871    3.15247   -5.379 7.50e-08 ***
b46            2.59583    3.35643    0.773 0.439294    
b47          -15.63686    3.15213   -4.961 7.04e-07 ***
b48            1.40897    3.35489    0.420 0.674506    
b49          -15.09448    3.15156   -4.790 1.68e-06 ***
b50            1.95820    3.35485    0.584 0.559430    
b51          -16.68432    3.15211   -5.293 1.21e-07 ***
b52            3.51436    3.35640    1.047 0.295075    
b53          -17.40231    3.15248   -5.520 3.40e-08 ***
b54            2.33273    3.35643    0.695 0.487057    
b55          -17.15896    3.15213   -5.444 5.24e-08 ***
b56            3.21393    3.35490    0.958 0.338076    
b57          -18.20573    3.15156   -5.777 7.65e-09 ***
b58            3.58231    3.35486    1.068 0.285617    
b59          -17.72138    3.15211   -5.622 1.90e-08 ***
b60            0.82705    3.35641    0.246 0.805367    
b61          -14.91699    3.15248   -4.732 2.23e-06 ***
b62            3.12398    3.35644    0.931 0.351991    
b63          -15.17646    3.15213   -4.815 1.48e-06 ***
b64            1.16292    3.35490    0.347 0.728867    
b65          -18.21854    3.15156   -5.781 7.47e-09 ***
b66            2.98755    3.35486    0.891 0.373194    
b67          -19.71656    3.15211   -6.255 4.00e-10 ***
b68            2.91935    3.35641    0.870 0.384423    
b69          -18.29201    3.15248   -5.802 6.57e-09 ***
b70            3.64665    3.35644    1.086 0.277279    
b71          -20.99795    3.15213   -6.662 2.73e-11 ***
b72            2.13914    3.35491    0.638 0.523727    
b73          -16.08586    3.15156   -5.104 3.33e-07 ***
b74            1.32997    3.35487    0.396 0.691789    
b75          -17.55250    3.15212   -5.568 2.58e-08 ***
b76            4.17701    3.35642    1.244 0.213327    
b77          -13.22021    3.15248   -4.194 2.75e-05 ***
b78            2.85330    3.35645    0.850 0.395275    
b79          -18.13959    3.15213   -5.755 8.72e-09 ***
b80            3.00548    3.35491    0.896 0.370340    
b81          -13.62284    3.15156   -4.323 1.54e-05 ***
b82            0.94460    3.35487    0.282 0.778282    
b83          -18.86513    3.15212   -5.985 2.18e-09 ***
b84            6.76046    3.35642    2.014 0.043994 *  
b85          -16.93210    3.15248   -5.371 7.86e-08 ***
b86            3.42242    3.35645    1.020 0.307896    
b87          -19.53157    3.15213   -6.196 5.82e-10 ***
b88            1.50996    3.35491    0.450 0.652658    
b89          -17.86235    3.15156   -5.668 1.45e-08 ***
b90            3.52758    3.35488    1.051 0.293044    
b91          -21.85533    3.15212   -6.934 4.15e-12 ***
b92            2.92439    3.35643    0.871 0.383605    
b93          -16.78123    3.15248   -5.323 1.02e-07 ***
b94            1.45670    3.35645    0.434 0.664291    
b95          -17.17860    3.15213   -5.450 5.06e-08 ***
b96            2.99419    3.35492    0.892 0.372140    
b97          -19.57645    3.15156   -6.212 5.28e-10 ***
b98            2.84144    3.35488    0.847 0.397022    
b99          -15.82041    3.15212   -5.019 5.21e-07 ***
b100           2.21992    3.35643    0.661 0.508363    
b101         -14.05359    3.15248   -4.458 8.29e-06 ***
b102           0.78650    3.35646    0.234 0.814734    
b103         -15.51662    3.15213   -4.923 8.56e-07 ***
b104           2.59591    3.35492    0.774 0.439074    
b105         -16.10712    3.15157   -5.111 3.22e-07 ***
b106           2.45863    3.35489    0.733 0.463652    
b107         -18.16054    3.15212   -5.761 8.38e-09 ***
b108           2.98491    3.35643    0.889 0.373840    
b109         -15.08241    3.15249   -4.784 1.72e-06 ***
b110           2.99094    3.35646    0.891 0.372880    
b111         -16.70017    3.15214   -5.298 1.17e-07 ***
b112           1.96914    3.35493    0.587 0.557245    
b113         -15.45949    3.15157   -4.905 9.35e-07 ***
b114           2.74430    3.35490    0.818 0.413363    
b115         -15.59554    3.15214   -4.948 7.53e-07 ***
b116           2.95318    3.35650    0.880 0.378950    
b117         -13.95390    3.15258   -4.426 9.61e-06 ***
b118           3.87786    3.35682    1.155 0.248006    
b119         -16.95669    3.15267   -5.379 7.54e-08 ***
b120           4.58033    3.35689    1.364 0.172430    
b121         -17.26554    3.15268   -5.476 4.36e-08 ***
b122           5.91940    3.35691    1.763 0.077847 .  
b123         -16.37058    3.15266   -5.193 2.08e-07 ***
b124           3.65558    3.35687    1.089 0.276165    
b125         -15.28517    3.15257   -4.848 1.25e-06 ***
b126           1.69025    3.35659    0.504 0.614571    
b127         -12.78583    3.15213   -4.056 4.99e-05 ***
b128           0.96039    3.35499    0.286 0.774682    
b129         -17.83139    3.15156   -5.658 1.54e-08 ***
b130           1.95538    3.35499    0.583 0.560012    
b131         -17.82282    3.15213   -5.654 1.57e-08 ***
b132           4.23404    3.35653    1.261 0.207158    
b133         -15.21113    3.15248   -4.825 1.40e-06 ***
b134           4.21815    3.35653    1.257 0.208867    
b135         -17.78243    3.15211   -5.641 1.69e-08 ***
b136           2.68187    3.35498    0.799 0.424080    
b137         -15.93273    3.15156   -5.056 4.31e-07 ***
b138           4.42938    3.35498    1.320 0.186761    
b139         -14.89319    3.15213   -4.725 2.31e-06 ***
b140           1.82828    3.35653    0.545 0.585966    
b141         -13.10942    3.15247   -4.158 3.21e-05 ***
b142           1.42456    3.35653    0.424 0.671266    
b143         -14.05821    3.15211   -4.460 8.21e-06 ***
b144           3.88441    3.35498    1.158 0.246948    
b145         -18.51044    3.15155   -5.873 4.29e-09 ***
b146           4.58203    3.35498    1.366 0.172027    
b147         -14.35010    3.15213   -4.553 5.31e-06 ***
b148           3.90030    3.35653    1.162 0.245238    
b149         -15.56626    3.15247   -4.938 7.92e-07 ***
b150           3.86080    3.35652    1.150 0.250051    
b151         -15.49335    3.15211   -4.915 8.89e-07 ***
b152           3.88866    3.35498    1.159 0.246432    
b153         -16.22381    3.15155   -5.148 2.64e-07 ***
b154           4.49440    3.35498    1.340 0.180374    
b155         -17.03015    3.15212   -5.403 6.59e-08 ***
b156           1.00084    3.35653    0.298 0.765569    
b157         -16.77539    3.15247   -5.321 1.03e-07 ***
b158           3.89260    3.35652    1.160 0.246171    
b159         -12.59081    3.15210   -3.994 6.49e-05 ***
b160           3.56641    3.35498    1.063 0.287777    
b161         -17.96464    3.15155   -5.700 1.20e-08 ***
b162           4.56086    3.35498    1.359 0.174017    
b163         -11.61011    3.15212   -3.683 0.000230 ***
b164           3.96682    3.35653    1.182 0.237280    
b165         -14.18027    3.15247   -4.498 6.87e-06 ***
b166           4.50046    3.35652    1.341 0.179987    
b167         -17.66374    3.15210   -5.604 2.11e-08 ***
b168           4.24654    3.35498    1.266 0.205611    
b169         -15.85387    3.15155   -5.031 4.91e-07 ***
b170           1.56868    3.35498    0.468 0.640095    
b171         -14.19493    3.15212   -4.503 6.70e-06 ***
b172           2.25259    3.35653    0.671 0.502155    
b173         -17.25596    3.15247   -5.474 4.42e-08 ***
b174           1.95258    3.35652    0.582 0.560753    
b175         -15.22137    3.15210   -4.829 1.38e-06 ***
b176           3.52159    3.35498    1.050 0.293879    
b177         -15.25088    3.15155   -4.839 1.31e-06 ***
b178           2.91344    3.35498    0.868 0.385184    
b179         -13.85193    3.15212   -4.394 1.11e-05 ***
b180           1.66617    3.35653    0.496 0.619616    
b181         -14.31123    3.15247   -4.540 5.64e-06 ***
b182           3.76724    3.35652    1.122 0.261712    
b183         -14.79560    3.15210   -4.694 2.69e-06 ***
b184           6.32896    3.35498    1.886 0.059241 .  
b185         -13.63137    3.15155   -4.325 1.53e-05 ***
b186           2.29581    3.35498    0.684 0.493789    
b187         -11.87787    3.15212   -3.768 0.000165 ***
b188           2.06957    3.35653    0.617 0.537514    
b189         -17.02265    3.15246   -5.400 6.70e-08 ***
b190           4.20213    3.35652    1.252 0.210600    
b191         -15.62880    3.15210   -4.958 7.13e-07 ***
b192           3.36663    3.35498    1.003 0.315637    
b193         -16.19496    3.15154   -5.139 2.77e-07 ***
b194           4.09894    3.35498    1.222 0.221808    
b195         -13.80039    3.15212   -4.378 1.20e-05 ***
b196           2.67715    3.35653    0.798 0.425108    
b197         -14.01281    3.15246   -4.445 8.80e-06 ***
b198           4.65761    3.35652    1.388 0.165254    
b199         -15.71280    3.15209   -4.985 6.22e-07 ***
b200           4.73846    3.35497    1.412 0.157846    
b201         -17.14761    3.15154   -5.441 5.32e-08 ***
b202           3.33309    3.35498    0.993 0.320483    
b203         -14.45197    3.15211   -4.585 4.55e-06 ***
b204           4.61674    3.35652    1.375 0.168996    
b205         -13.32388    3.15246   -4.227 2.38e-05 ***
b206           3.07539    3.35652    0.916 0.359543    
b207         -15.67334    3.15209   -4.972 6.63e-07 ***
b208           3.45142    3.35497    1.029 0.303602    
b209         -14.48906    3.15154   -4.597 4.29e-06 ***
b210           3.67300    3.35498    1.095 0.273613    
b211         -14.58418    3.15211   -4.627 3.72e-06 ***
b212           2.89612    3.35652    0.863 0.388233    
b213         -14.05122    3.15246   -4.457 8.32e-06 ***
b214           4.51874    3.35652    1.346 0.178224    
b215         -15.92433    3.15209   -5.052 4.39e-07 ***
b216           5.45701    3.35497    1.627 0.103839    
b217         -16.72211    3.15154   -5.306 1.12e-07 ***
b218           5.88130    3.35498    1.753 0.079606 .  
b219         -13.19603    3.15211   -4.186 2.84e-05 ***
b220           5.52534    3.35652    1.646 0.099738 .  
b221         -15.40899    3.15246   -4.888 1.02e-06 ***
b222           3.09749    3.35651    0.923 0.356099    
b223         -12.55800    3.15209   -3.984 6.78e-05 ***
b224           2.68139    3.35497    0.799 0.424162    
b225         -13.05231    3.15154   -4.142 3.45e-05 ***
b226           4.06904    3.35498    1.213 0.225198    
b227         -12.35994    3.15211   -3.921 8.82e-05 ***
b228           4.51959    3.35652    1.347 0.178144    
b229         -13.13081    3.15245   -4.165 3.11e-05 ***
b230           2.89354    3.35651    0.862 0.388654    
b231         -12.28935    3.15208   -3.899 9.68e-05 ***
b232           5.25760    3.35497    1.567 0.117094    
b233         -16.18454    3.15153   -5.135 2.82e-07 ***
b234           3.52089    3.35498    1.049 0.293975    
b235         -13.18897    3.15211   -4.184 2.87e-05 ***
b236           3.58085    3.35652    1.067 0.286052    
b237         -13.29325    3.15245   -4.217 2.48e-05 ***
b238           2.61268    3.35651    0.778 0.436341    
b239         -15.09908    3.15208   -4.790 1.67e-06 ***
b240           6.48130    3.35497    1.932 0.053382 .  
b241         -16.33186    3.15153   -5.182 2.20e-07 ***
b242           5.38963    3.35498    1.606 0.108179    
b243         -15.86905    3.15211   -5.034 4.81e-07 ***
b244           5.44231    3.35652    1.621 0.104934    
b245         -14.40312    3.15245   -4.569 4.91e-06 ***
b246           3.94301    3.35651    1.175 0.240105    
b247         -15.78408    3.15208   -5.008 5.53e-07 ***
b248           4.81673    3.35496    1.436 0.151092    
b249         -13.89978    3.15153   -4.410 1.03e-05 ***
b250           3.66395    3.35498    1.092 0.274796    
b251         -14.88348    3.15210   -4.722 2.34e-06 ***
b252           3.24548    3.35652    0.967 0.333589    
b253         -14.00244    3.15245   -4.442 8.94e-06 ***
b254           3.91173    3.35651    1.165 0.243854    
b255         -14.60377    3.15208   -4.633 3.61e-06 ***
b256           2.75128    3.35496    0.820 0.412184    
b257         -14.55823    3.15153   -4.619 3.86e-06 ***
b258           4.21810    3.35498    1.257 0.208662    
b259         -14.40142    3.15210   -4.569 4.91e-06 ***
b260           4.38682    3.35652    1.307 0.191233    
b261         -15.95137    3.15244   -5.060 4.21e-07 ***
b262           6.31251    3.35651    1.881 0.060021 .  
b263         -16.79311    3.15207   -5.328 9.99e-08 ***
b264           6.77983    3.35496    2.021 0.043301 *  
b265         -15.78045    3.15152   -5.007 5.54e-07 ***
b266           3.86395    3.35498    1.152 0.249446    
b267         -13.30531    3.15210   -4.221 2.43e-05 ***
b268           5.36866    3.35652    1.599 0.109721    
b269         -14.67223    3.15244   -4.654 3.26e-06 ***
b270           3.69927    3.35650    1.102 0.270414    
b271         -12.57958    3.15207   -3.991 6.59e-05 ***
b272           3.68350    3.35496    1.098 0.272241    
b273         -11.75690    3.15152   -3.731 0.000191 ***
b274           0.58788    3.35497    0.175 0.860903    
b275         -13.30008    3.15210   -4.219 2.45e-05 ***
b276           4.33069    3.35651    1.290 0.196974    
b277         -16.38659    3.15244   -5.198 2.02e-07 ***
b278           4.37969    3.35650    1.305 0.191953    
b279         -15.51687    3.15207   -4.923 8.56e-07 ***
b280           3.52139    3.35496    1.050 0.293902    
b281         -13.45430    3.15152   -4.269 1.97e-05 ***
b282           2.01294    3.35497    0.600 0.548517    
b283         -13.36409    3.15209   -4.240 2.24e-05 ***
b284           3.05635    3.35651    0.911 0.362523    
b285         -15.59372    3.15244   -4.947 7.57e-07 ***
b286           4.22508    3.35650    1.259 0.208116    
b287         -12.50287    3.15206   -3.967 7.30e-05 ***
b288           3.84187    3.35495    1.145 0.252158    
b289         -15.23955    3.15152   -4.836 1.33e-06 ***
b290           4.30305    3.35497    1.283 0.199641    
b291         -13.19507    3.15209   -4.186 2.84e-05 ***
b292           2.81578    3.35651    0.839 0.401529    
b293         -12.44891    3.15243   -3.949 7.86e-05 ***
b294           1.88328    3.35650    0.561 0.574742    
b295         -10.32553    3.15206   -3.276 0.001054 ** 
b296           3.02929    3.35495    0.903 0.366565    
b297         -12.75303    3.15151   -4.047 5.20e-05 ***
b298           4.14203    3.35497    1.235 0.216986    
b299         -13.44370    3.15209   -4.265 2.00e-05 ***
b300           2.95628    3.35651    0.881 0.378451    
b301         -12.62797    3.15243   -4.006 6.19e-05 ***
b302           3.29403    3.35649    0.981 0.326405    
b303         -10.86602    3.15206   -3.447 0.000567 ***
b304           4.32251    3.35495    1.288 0.197613    
b305         -13.83464    3.15151   -4.390 1.14e-05 ***
b306           1.84848    3.35497    0.551 0.581657    
b307         -13.07568    3.15209   -4.148 3.35e-05 ***
b308           3.11532    3.35651    0.928 0.353338    
b309         -15.87186    3.15243   -5.035 4.80e-07 ***
b310           5.58302    3.35649    1.663 0.096248 .  
b311         -12.94187    3.15205   -4.106 4.03e-05 ***
b312           4.04492    3.35495    1.206 0.227954    
b313         -15.95108    3.15151   -5.061 4.17e-07 ***
b314           4.69483    3.35497    1.399 0.161708    
b315         -13.99548    3.15208   -4.440 9.01e-06 ***
b316           2.87756    3.35651    0.857 0.391278    
b317          -9.61938    3.15242   -3.051 0.002279 ** 
b318           4.27842    3.35649    1.275 0.202430    
b319         -11.15417    3.15204   -3.539 0.000402 ***
b320           4.62982    3.35493    1.380 0.167591    
b321         -11.52350    3.15147   -3.657 0.000256 ***
b322           2.72951    3.35492    0.814 0.415887    
b323         -13.04417    3.15193   -4.138 3.50e-05 ***
b324           6.14282    3.35645    1.830 0.067232 .  
b325         -11.83705    3.15255   -3.755 0.000174 ***
b326           5.11443    3.36097    1.522 0.128087    
b327         -16.07414    3.18413   -5.048 4.47e-07 ***
b328           6.30042    3.83027    1.645 0.099995 .  
b329         785.90144 2467.37668    0.319 0.750094    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 4.153 on 59317 degrees of freedom
  (7401 observations deleted due to missingness)
Multiple R-squared:  0.8403,	Adjusted R-squared:  0.8394 
F-statistic: 936.9 on 333 and 59317 DF,  p-value: < 2.2e-16

> 
> # register the results
> data <- data %>% mutate(mu = NA , ctemp = NA)
> for(k in 1:p){
+   data[non_na & row_ids[,k],] <- data[non_na & row_ids[,k],] %>% 
+     mutate(mu = lms[[k]]$fitted.values, ctemp = mean_temp - mu)
+ }
> 
> # remove b cols of data (for memory)
> data <- data %>% 
+   select(!any_of(b_cols[[which.max(sapply(b_cols, length))]])) %>%
+   select(!any_of(c(s_cols, c_cols)))
> gc()
            used   (Mb) gc trigger   (Mb)  max used   (Mb)
Ncells   2493350  133.2    4520294  241.5   4520294  241.5
Vcells 164099072 1252.0  550525562 4200.2 458683666 3499.5
> 
> # quick check
> data0 <- data %>% group_by(year, station_name) %>%
+   summarise(m_mt = mean(mean_temp, na.rm=T),
+             m_mu = mean(mu, na.rm=T))
`summarise()` has grouped output by 'year'. You can override using the
`.groups` argument.
> ggplot(data0, aes(x=year, y=m_mt, col=station_name, group=station_name)) +
+   theme_light() +
+   geom_line(data = data0, aes(y=m_mu), col=1) +
+   geom_point()
Warning messages:
1: Removed 20 row(s) containing missing values (geom_path). 
2: Removed 25 rows containing missing values (geom_point). 
> 
> data0 <- data %>% filter(year %in% 1950:1970) %>%
+   group_by(year, month, station_name) %>%
+   summarise(m_mt = mean(mean_temp, na.rm=T),
+             m_mu = mean(mu, na.rm=T))
`summarise()` has grouped output by 'year', 'month'. You can override using the
`.groups` argument.
> ggplot(data0, aes(x=year+month/12, y=m_mt, col=station_name, group=station_name)) +
+   geom_line() + geom_point() +
+   geom_line(data = data0, aes(y=m_mu)) +
+   facet_wrap(~station_name)
Warning messages:
1: Removed 21 row(s) containing missing values (geom_path). 
2: Removed 21 rows containing missing values (geom_point). 
3: Removed 21 row(s) containing missing values (geom_path). 
> 
> 
> # random check of the fits
> # some plots might show a break (when the data goes from Ottawa to Toronto)
> k <- sample(nrow(data),1)
> ii <- k + 1:365
> plot(data$time[ii], data$mean_temp[ii])
> lines(data$time[ii], data$mu[ii], col=2)
> 
> 
> # note that this breaks the equalities in the data
> # but there is still some heterogeneity in the variance
> N <- 20000 
> par(mfrow=c(p,2), mar=c(1,1,0,0))
> for(k in 1:p){
+   plot(data$yday[row_ids[,k]][1:N], data$mean_temp[row_ids[,k]][1:N], cex=.25)
+   plot(data$yday[row_ids[,k]][1:N], data$ctemp[row_ids[,k]][1:N], cex=.25)
+ }
> 
> 
> 
> # Compute pseudo-observations using ECDF ----------------------------------
> data <- data %>% mutate(pseudo_temp = NA, diff = NA, w1 = NA, w = NA)
> for(k in 1:p){
+   id <- stns_id[k]
+   cat("Working on ECDF for station ", id, ".\n")
+   row_id <- row_ids[,k]
+   
+   for(tt in 1:366){
+     if(tt %% 20 == 0) cat("progess: ", round(tt/366*100,2), "%\n")
+     
+     # construct weights based on yday using gaussian kernel
+     data[row_id,] <- data[row_id,] %>%
+       mutate(diff = tt - (time %% year_len)) %>%
+       mutate(diff = abs(pmin(diff, year_len - diff))) %>%
+       mutate(w1 = dnorm(diff,0,1)) %>%
+       mutate(w = w1/sum(w1, na.rm = T)) 
+     
+     # construct ecdf function using all the data
+     wecdf <- spatstat.geom::ewcdf(data[row_id,]$ctemp, data[row_id,]$w)
+     
+     # compute ecdf only for yday we care for
+     ind <- which(data[row_id,]$yday == tt & !is.na(data[row_id,]$ctemp))
+     data[row_id,][ind,] <- data[row_id,][ind,] %>%
+       mutate(pseudo_temp = wecdf(ctemp))
+     
+     # heuristic correction for the largest (pseudo_obs = 1)
+     # to avoid modifying all values (say, with pseudo_obs = pseudo_obs*n_ind/(n_ind+1))
+     n_ind <- length(ind)
+     data[row_id,][ind,] <- data[row_id,][ind,] %>%
+       mutate(pseudo_temp = ifelse(pseudo_temp == 1, 1-1/(2*n_ind), pseudo_temp))
+   }
+ }
Working on ECDF for station  568 .
progess:  5.46 %
progess:  10.93 %
progess:  16.39 %
progess:  21.86 %
progess:  27.32 %
progess:  32.79 %
progess:  38.25 %
progess:  43.72 %
progess:  49.18 %
progess:  54.64 %
progess:  60.11 %
progess:  65.57 %
progess:  71.04 %
progess:  76.5 %
progess:  81.97 %
progess:  87.43 %
progess:  92.9 %
progess:  98.36 %
Working on ECDF for station  4333 .
progess:  5.46 %
progess:  10.93 %
progess:  16.39 %
progess:  21.86 %
progess:  27.32 %
progess:  32.79 %
progess:  38.25 %
progess:  43.72 %
progess:  49.18 %
progess:  54.64 %
progess:  60.11 %
progess:  65.57 %
progess:  71.04 %
progess:  76.5 %
progess:  81.97 %
progess:  87.43 %
progess:  92.9 %
progess:  98.36 %
Working on ECDF for station  5051 .
progess:  5.46 %
progess:  10.93 %
progess:  16.39 %
progess:  21.86 %
progess:  27.32 %
progess:  32.79 %
progess:  38.25 %
progess:  43.72 %
progess:  49.18 %
progess:  54.64 %
progess:  60.11 %
progess:  65.57 %
progess:  71.04 %
progess:  76.5 %
progess:  81.97 %
progess:  87.43 %
progess:  92.9 %
progess:  98.36 %
> 
> 
> 
> # resulting histograms are even better than expected
> ggplot(data, aes(x = pseudo_temp, fill=as.factor(yday))) +
+   theme(legend.position = "none") +
+   geom_histogram(breaks=seq(0,1,.05), position = position_stack()) +
+   facet_wrap(~station_name)
Warning message:
Removed 12480 rows containing non-finite values (stat_bin). 
> 
> # quick check of the other operations (tt = 366, last it. of for loop)
> s <- sample(nrow(data) - 1000,1)
> par(mfrow=c(3,1))
> plot(data$pseudo_temp[s + 1:100], type="o") # makes sense
> plot(data$date[s + 1:1000], data$diff[s + 1:1000]) # linear in time, as expected
> plot(data$date[s + 1:1000], data$w[s + 1:1000], type="l") # select only end of year periods
> 
> # note that there are equalities, but very very few of them. can disregard.
> apply(row_ids, 2, \(r){
+   tab <- table(data[r,]$pseudo_temp)
+   tab[tab > 1]
+ })
[[1]]

0.102629944289836 0.110947451693739 0.194872513179304 0.426156518937491 
                2                 2                 2                 2 
0.680429851614981 0.873234478527406 0.995798319327731 0.995867768595041 
                2                 2                 3                 2 
0.995901639344262 0.995934959349594 0.995967741935484             0.996 
                3                 3                 4                 5 
                1 
                2 

[[2]]

0.105479620001059 0.408525939643252 0.435998156711367 0.609305434109175 
                2                 2                 2                 2 
0.658855512630679 0.739594115091484 0.993103257960187 0.996212121212121 
                2                 3                 2                 3 
0.996240601503759 0.996268656716418                 1 
                9                 8                 3 

[[3]]

0.108903950611147 0.216362354001505 0.240077073843999 0.336580167605903 
                2                 2                 2                 2 
0.691270786750041  0.84585425153056 0.858399286686548 0.996932515337423 
                2                 2                 2                16 
0.996951219512195                 1 
                7                 3 

> 
> 
> 
> # Save for later use ------------------------------------------------------
> saveRDS(data, "app/data/data_pp8.rds")
> 
> proc.time()
    user   system  elapsed 
1342.182   11.324 1353.568 
